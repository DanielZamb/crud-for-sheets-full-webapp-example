<script>
  $(document).ready(function () {
    const $modules = $(".module");
    $(".offcanvas-body").on("click", "li.nav-item", function () {
        $(".nav-item").removeClass("active");
        $(this).addClass("active");

        $modules.hide();

        const moduleId = $(this).attr("data-module");
        $(`#${moduleId}`).show();
    })

    const categoryModule = {
        categoryTable: null,
        currentRow: null,
    }

    function initCategoryTable() {
        categoryModule.categoryTable = $("#categoryTable").DataTable({
            responsive: true,
            language: {
                "lengthMenu": "Mostrar _MENU_ categorias por página",
                "zeroRecords": "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
                      <div class="btn-group" role="group">
                        <button class="btn-custom btn-warning btn-rounded editCategory" data-id="${data}">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-custom btn-danger btn-rounded deleteCategory" data-id="${data}">
                          <i class="bi bi-trash"></i>
                        </button>
                        <button type="button" class="btn-custom btn-info btn-rounded readCategory" data-id="${data}">
                          <i class="bi bi-info-circle-fill"></i>
                        </button>
                      </div>`;
                    }
                },
                {data: "date"},
                {data: "name"},
                {data: "created_at"}
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"}
            ]
        })
    }

    function loadCategories() {
        google.script.run
            .withSuccessHandler(handleCategoriesLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar categorias", error))
            .readCategoryTable();
    }

    function handleCategoriesLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "categories");
        categoryModule.categoryTable.clear().rows.add(data.data).draw();
    }

    function initCategoryManagement() {
        if (categoryModule.categoryTable) {
            categoryModule.categoryTable.destroy();
        }
        initCategoryTable();
        loadCategories();
    }

    initCategoryManagement();

    $("#refreshCategoryTable").click(function () {
        defaultLoadingSwalToast("traigo nueva info!")
        loadCategories();
    })

    $("#createNewCategory").click(function () {
        $("#categoryModule").carousel(1);
    })

    $("#createCategoryForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("creo la categoria!")
        const newCatName = $("#createCategoryName").val().length > 0 ? $("#createCategoryName").val() : null;
        const newCatDate = $("#createCategoryDate").val();
        payload = {name: newCatName, created_at: newCatDate}
        // if (!newCatName){
        //   delete payload.name;
        // }
        google.script.run
            .withSuccessHandler((response) => {
                Swal.fire("Exito!", "Categoria Creada", "success");
                response = JSON.parse(response);
                console.log("created new category!", response);
                // const newCategory = response.
            })
            .createCategory(payload);

        console.log("Submitting new category:", newCatName, newCatDate);
    });

    $("#editCategoryForm").on("submit", function (e) {
        e.preventDefault();

        const catId = categoryModule.currentRow.id;
        const catName = $("#editCategoryName").val();
        const catDate = $("#editCategoryDate").val();

        // Find the row being edited
        const $row = categoryModule.categoryTable.rows().nodes().toArray().find(row => {
            return categoryModule.categoryTable.row(row).data().id === catId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'categoria',
            fields: {
                '#editCategoryName': 'name',
                '#editCategoryDate': 'created_at'
            },
            id: catId,
            updatedData: { name: catName, created_at: catDate },
            dataTable: categoryModule.categoryTable,
            $dataTableRow: $row,
            reloaderFunc: loadCategories,
            scriptConfig: {
                mainFunction: 'updateCategory',
                readRecordFunc: 'readCategoryById',
                requiresObject: true
            }
        });

        console.log("Updating category:", catId, catName, catDate);
    });

    // Listen for clicks on the editCategory button in each table row
    $("#categoryTable").on("click", ".editCategory", function () {
        // Get the category ID from the data-id attribute
        const catId = $(this).data("id");

        currentRow = categoryModule.categoryTable.row($(this).closest("tr")).data();

        console.log("Editing category:", catId, currentRow);

        // Fill the "Edit Category" form fields
        $("#editCategoryName").val(currentRow.name);
        // Decide which date field you want to use (rowData.date or rowData.created_at)
        $("#editCategoryDate").val(currentRow.created_at.substr(0, 10));

        $("#categoryModule").carousel(2);
    });

    $("#categoryTable").on("click", ".deleteCategory", function () {
        const catId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = categoryModule.categoryTable.row($row).data();
        console.log("Deleting category:", catId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'categoria',
            id: catId,
            dataTable: categoryModule.categoryTable,
            $dataTableRow: $row,
            reloaderFunc: loadCategories,
            scriptConfig: {
                mainFunction: 'removeCategory',
                readRecordFunc: 'readCategoryById',
                requiresObject: false
            }
        });
    })
    $("#categoryTable").on("click", ".readCategory", function () {
      const $row = $(this).closest("tr");
      const rowData = categoryModule.categoryTable.row($row).data();
      const categoryId = rowData.id;
      console.log("Reading products for Category ID:", categoryId);

      google.script.run
        .withSuccessHandler(displayCategoryOffcanvasResults)
        .getCategoryRelatedRecords(
          categoryId,
        );
    });

    window.lastCategoryResults = null;

    function displayCategoryOffcanvasResults(serverResponse) {
      const data = JSON.parse(serverResponse);
      window.lastCategoryResults = data;

      // Start with cards view
      buildCategoryCardsView(data);

      // Show the wide offcanvas
      const offcanvasEl = document.getElementById("offcanvasCategory");
      const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
      bsOffcanvas.show();
    }

    // Toggle between JSON and cards for Category
    $("#toggleViewBtnCategory").on("click", function () {
      const currentView = $(this).attr("data-view");
      const data = window.lastCategoryResults || { data: [] };
      if (!data || !data.data) return;

      if (currentView === "cards") {
        // Switch to JSON
        buildCategoryJsonView(data);
        $(this).attr("data-view", "json").text("Ver Cards");
      } else {
        // Switch back to Cards
        buildCategoryCardsView(data);
        $(this).attr("data-view", "cards").text("Ver JSON");
      }
    });

    // Build Cards for Category
    function buildCategoryCardsView(response) {
      const $body = $("#offcanvasCategoryBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron productos.</p>`);
        return;
      }

      response.data.forEach((item) => {
        /* Suppose each "item" is a Product row:
          { id: 123, name: "Laptop", price: 999, category_fk: 4, created_at: "2024-01-01" }
        */
        const cardHtml = `
          <div class="card mb-2">
            <div class="card-body d-flex">
              <i class="bi bi-laptop me-3" style="font-size:2rem;"></i>
              <div>
                <h5 class="card-title mb-0">${item.name}</h5>
                <small class="text-muted">ID: ${item.id}</small>
                <p class="mt-2 mb-0">Precio: $${item.price}</p>
                <p class="mb-0">Fecha: ${item.created_at || "N/A"}</p>
              </div>
            </div>
          </div>`;
        $body.append(cardHtml);
      });
    }

    // Build JSON for Category
    function buildCategoryJsonView(response) {
      const $body = $("#offcanvasCategoryBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron productos.</p>`);
        return;
      }

      const pre = $("<pre></pre>").text(JSON.stringify(response.data, null, 2));
      $body.append(pre);
    }


    /****************************************************
     * Order Module Logic
     ****************************************************/
    const orderModule = {
        orderTable: null,
        currentRow: null, // store the currently selected row data (for editing)
    };


    function initOrderTable() {
        orderModule.orderTable = $("#orderTable").DataTable({
            responsive: true,
            language: {
                lengthMenu: "Mostrar _MENU_ órdenes por página",
                zeroRecords: "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
              <div class="btn-group" role="group">
                <button class="btn-custom btn-warning btn-rounded editOrder" data-id="${data}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn-custom btn-danger btn-rounded deleteOrder" data-id="${data}">
                  <i class="bi bi-trash"></i>
                </button>
                <button type="button" class="btn-custom btn-info btn-rounded readOrder" data-id="${data}">
                  <i class="bi bi-info-circle-fill"></i>
                </button>
              </div>`;
                    },
                },
                {data: "customer_fk"},
                {data: "created_at"},
                {data: "date"},
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"},
            ],
        });
    }

    function loadOrders() {
        google.script.run
            .withSuccessHandler(handleOrdersLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar órdenes", error))
            .readOrderTable();
    }

    function handleOrdersLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "orders");
        orderModule.orderTable.clear().rows.add(data.data).draw();
    }


    function loadCustomersForSelect() {
        google.script.run
            .withSuccessHandler(function (response) {
                const data = JSON.parse(response);
                if (data.status === 200) {
                    const customers = data.data.map(c => ({
                        id: c.id,
                        text: c.first_name + " " + c.last_name
                    }));
                    const $select = $("#createOrderCustomer, #editOrderCustomer");
                    $select.empty(); // remove placeholder option
                    $select.select2({
                        dropdownAutoWidth: true,
                        width: '100%',
                        data: customers,
                        theme: "bootstrap-5",
                        placeholder: "Seleccione un cliente",
                        allowClear: true
                    });
                } else {
                    console.error("Error loading customers:", data);
                }
            })
            .withFailureHandler(function (err) {
                console.error("Apps Script error loading customers:", err);
            })
            .readCustomerTable();
    }

    /**
     * Re-initializes the Order table if needed, then loads data.
     */
    function initOrderManagement() {
        if (orderModule.orderTable) {
            orderModule.orderTable.destroy();
        }
        initOrderTable();
        loadOrders();

        $("#createOrderCustomer, #editOrderCustomer").select2({
            theme: "bootstrap-5", // if using the bootstrap theme
            placeholder: "Seleccione un cliente",
            allowClear: true
        });
        loadCustomersForSelect();
    }

    // Call this once when the page is ready
    initOrderManagement();

    /****************************************************
     * Refresh Table
     ****************************************************/
    $("#refreshOrderTable").click(function () {
        defaultLoadingSwalToast("Cargando la información de órdenes...");
        loadOrders();
    });

    /****************************************************
     * CREATE NEW ORDER
     ****************************************************/
    $("#createNewOrder").click(function () {
        // Move carousel to the “Create Order” form
        $("#orderModule").carousel(1);
    });

    $("#createOrderForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("Creando nueva orden...");

        // Gather form values
        const newOrderCustomer = $("#createOrderCustomer").val();
        const newOrderDate = $("#createOrderDate").val();

        // Make server call
        google.script.run
            .withSuccessHandler((response) => {
                response = JSON.parse(response);
                if (response.status === 200) {
                    Swal.fire("Éxito!", "Orden creada correctamente", "success");
                    console.log("Created new order!", response);

                    // Optionally reload or append row to table
                    loadOrders();
                } else {
                    Swal.fire("Error", "No se pudo crear la orden", "error");
                }
            })
            .createOrder({
                customer_fk: Number(newOrderCustomer),
                created_at: newOrderDate,
            });

        console.log("Submitting new order:", newOrderCustomer, newOrderDate);
    });

    /****************************************************
     * EDIT ORDER
     ****************************************************/
    $("#editOrderForm").on("submit", function (e) {
        e.preventDefault();

        const orderId = orderModule.currentRow.id;
        const orderCustomer = $("#editOrderCustomer").val();
        const orderDate = $("#editOrderDate").val();

        // Find the row being edited
        const $row = orderModule.orderTable.rows().nodes().toArray().find(row => {
            return orderModule.orderTable.row(row).data().id === orderId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'orden',
            fields: {
                '#editOrderCustomer': 'customer_fk',
                '#editOrderDate': 'created_at'
            },
            id: orderId,
            updatedData: { customer_fk: Number(orderCustomer), created_at: orderDate },
            dataTable: orderModule.orderTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrders,
            scriptConfig: {
                mainFunction: 'updateOrder',
                readRecordFunc: 'readOrderById',
                requiresObject: true
            }
        });

        console.log("Updating order:", orderId, orderCustomer, orderDate);
    });

    /****************************************************
     * EDIT BUTTON CLICK
     ****************************************************/
    $("#orderTable").on("click", ".editOrder", function () {
        // Get the Order ID from the data-id attribute
        const orderId = $(this).data("id");
        // Store current row data in orderModule.currentRow
        orderModule.currentRow = orderModule.orderTable
            .row($(this).closest("tr"))
            .data();

        console.log("Editing order:", orderId, orderModule.currentRow);

        // Fill the Edit form
        $("#editOrderCustomer").val(orderModule.currentRow.customer_fk);
        // date? depends on how you store it. Example:
        $("#editOrderDate").val(
            orderModule.currentRow.created_at
                ? orderModule.currentRow.created_at.substr(0, 10)
                : ""
        );

        // Move carousel to the “Edit Order” form (3rd slide => index=2)
        $("#orderModule").carousel(2);
    });

    /****************************************************
     * DELETE BUTTON CLICK
     ****************************************************/
    $("#orderTable").on("click", ".deleteOrder", function () {
        const orderId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = orderModule.orderTable.row($row).data();
        console.log("Deleting order:", orderId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'orden',
            id: orderId,
            dataTable: orderModule.orderTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrders,
            scriptConfig: {
                mainFunction: 'removeOrder',
                readRecordFunc: 'readOrderById',
                requiresObject: false
            }
        });
    });

    /****************************************************
     * Product Module Logic
     ****************************************************/
    const productModule = {
        productTable: null,
        currentRow: null, // store data of the currently selected row
    };

    // 1) Initialize DataTable
    function initProductTable() {
        productModule.productTable = $("#productTable").DataTable({
            responsive: true,
            language: {
                lengthMenu: "Mostrar _MENU_ productos por página",
                zeroRecords: "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
                  <div class="btn-group" role="group">
                    <button class="btn-custom btn-warning btn-rounded editProduct" data-id="${data}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn-custom btn-danger btn-rounded deleteProduct" data-id="${data}">
                      <i class="bi bi-trash"></i>
                    </button>
                    <button type="button" class="btn-custom btn-info btn-rounded readProduct" data-id="${data}">
                      <i class="bi bi-info-circle-fill"></i>
                    </button>
                  </div>
                `;
                    },
                },
                {data: "name"},
                {data: "price"},
                {data: "category_fk"},
                {data: "created_at"},
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"},
            ],
        });
    }

    // 2) Load Products from Server
    function loadProducts() {
        google.script.run
            .withSuccessHandler(handleProductsLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar productos", error))
            .readProductTable(); // your server function
    }

    function handleProductsLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "products");
        productModule.productTable.clear().rows.add(data.data).draw();
    }

    // 3) Initialize the Module
    function initProductManagement() {
        if (productModule.productTable) {
            productModule.productTable.destroy();
        }
        initProductTable();
        loadProducts();
    }

    initProductManagement();

    // Convert #createProductCategoryFk & #editProductCategoryFk into Select2
    $("#createProductCategoryFk, #editProductCategoryFk").select2({
        theme: "bootstrap-5",
        placeholder: "Seleccione una categoría",
        allowClear: true,
    });

    // Load categories for the select2 dropdown
    loadCategoriesForSelect2();

    // Refresh products
    $("#refreshProductTable").on("click", function () {
        defaultLoadingSwalToast("Refrescando lista de productos...");
        loadProducts();
    });

    // Create new product => go to carousel second slide
    $("#createNewProduct").on("click", function () {
        $("#productModule").carousel(1);
    });

    // Handle CREATE form submission
    $("#createProductForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("Creando producto...");

        // Gather form values
        const newName = $("#createProductName").val();
        const newPrice = $("#createProductPrice").val();
        const newCatId = $("#createProductCategoryFk").val();  // from Select2
        const newDate = $("#createProductDate").val();

        google.script.run
            .withSuccessHandler((response) => {
                response = JSON.parse(response);
                if (response.status === 200) {
                    Swal.fire("Éxito!", "Producto creado correctamente", "success");
                    loadProducts();
                } else {
                    Swal.fire("Error", "No se pudo crear el producto", "error");
                    console.warn("Create product error:", response);
                }
            })
            .withFailureHandler((err) => {
                console.error("createProduct error:", err);
                Swal.fire("Error", "No se pudo crear el producto", "error");
            })
            .createProduct({
                name: newName,
                price: parseFloat(newPrice),
                category_fk: Number(newCatId),
                created_at: newDate,
            });
    });

    // Handle EDIT form submission
    $("#editProductForm").on("submit", function (e) {
        e.preventDefault();

        // The ID from the hidden input or from productModule.currentRow
        const prodId = $("#editProductId").val();

        // Gather form values
        const prodName = $("#editProductName").val();
        const prodPrice = $("#editProductPrice").val();
        const prodCatId = $("#editProductCategoryFk").val();
        const prodDate = $("#editProductDate").val();

        // Find the row being edited
        const $row = productModule.productTable.rows().nodes().toArray().find(row => {
            return productModule.productTable.row(row).data().id == prodId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'producto',
            fields: {
                '#editProductName': 'name',
                '#editProductPrice': 'price',
                '#editProductCategoryFk': 'category_fk',
                '#editProductDate': 'created_at'
            },
            id: prodId,
            updatedData: {
                name: prodName,
                price: parseFloat(prodPrice),
                category_fk: Number(prodCatId),
                created_at: prodDate
            },
            dataTable: productModule.productTable,
            $dataTableRow: $row,
            reloaderFunc: loadProducts,
            scriptConfig: {
                mainFunction: 'updateProduct',
                readRecordFunc: 'readProductById',
                requiresObject: true
            }
        });
    });

    /****************************************************
     * EDIT BUTTON CLICK in the table
     ****************************************************/
    $("#productTable").on("click", ".editProduct", function () {
        const prodId = $(this).data("id");
        productModule.currentRow = productModule.productTable
            .row($(this).closest("tr"))
            .data();

        console.log("Editing product:", prodId, productModule.currentRow);

        // Fill the edit form
        $("#editProductId").val(productModule.currentRow.id);
        $("#editProductName").val(productModule.currentRow.name);
        $("#editProductPrice").val(productModule.currentRow.price);
        $("#editProductCategoryFk")
            .val(productModule.currentRow.category_fk)
            .trigger("change");
        $("#editProductDate").val(
            productModule.currentRow.created_at
                ? productModule.currentRow.created_at.substr(0, 10)
                : ""
        );

        $("#productModule").carousel(2); // navigate to edit form
    });

    /****************************************************
     * DELETE BUTTON CLICK in the table
     ****************************************************/
    $("#productTable").on("click", ".deleteProduct", function () {
        const prodId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = productModule.productTable.row($row).data();

        console.log("Deleting product:", prodId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'producto',
            id: prodId,
            dataTable: productModule.productTable,
            $dataTableRow: $row,
            reloaderFunc: loadProducts,
            scriptConfig: {
                mainFunction: 'removeProduct',
                readRecordFunc: 'readProductById',
                requiresObject: false
            }
        });
    });

    /****************************************************
     * Load Categories for the select2 drop-down
     ****************************************************/
    function loadCategoriesForSelect2() {
        google.script.run
            .withSuccessHandler((response) => {
                const data = JSON.parse(response);
                if (data.status === 200) {
                    const categories = data.data; // array of {id, name, ...}
                    // Clear & repopulate both create/edit selects
                    const $createSelect = $("#createProductCategoryFk");
                    const $editSelect = $("#editProductCategoryFk");
                    $createSelect.empty();
                    $editSelect.empty();

                    // Append categories as <option>
                    categories.forEach((cat) => {
                        $createSelect.append(
                            new Option(cat.name, cat.id, false, false)
                        );
                        $editSelect.append(
                            new Option(cat.name, cat.id, false, false)
                        );
                    });

                    // Trigger change so Select2 can refresh
                    $createSelect.trigger("change");
                    $editSelect.trigger("change");
                } else {
                    console.error("Failed to load categories:", data);
                }
            })
            .withFailureHandler((err) => {
                console.error("Error loading categories:", err);
            })
            .readCategoryTable(); // or whatever your function is
    }


    /****************************************************
     * Customer Module Logic
     ****************************************************/
    const customerModule = {
        customerTable: null,
        currentRow: null, // store data of the currently selected row
    };

    /**
     * 1) Initialize DataTable
     */
    function initCustomerTable() {
        customerModule.customerTable = $("#customerTable").DataTable({
            responsive: true,
            language: {
                lengthMenu: "Mostrar _MENU_ clientes por página",
                zeroRecords: "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
                  <div class="btn-group" role="group">
                    <button class="btn-custom btn-warning btn-rounded editCustomer" data-id="${data}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn-custom btn-danger btn-rounded deleteCustomer" data-id="${data}">
                      <i class="bi bi-trash"></i>
                    </button>
                    <button type="button" class="btn-custom btn-info btn-rounded readCustomer" data-id="${data}">
                      <i class="bi bi-info-circle-fill"></i>
                    </button>
                  </div>
                `;
                    },
                },
                {data: "first_name"},
                {data: "last_name"},
                {data: "email"},
                {data: "address"},
                {data: "created_at"},
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"},
            ],
        });
    }

    /**
     * 2) Load Customers from Server
     */
    function loadCustomers() {
        google.script.run
            .withSuccessHandler(handleCustomersLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar clientes", error))
            .readCustomerTable(); // your server function
    }

    function handleCustomersLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "customers");
        customerModule.customerTable.clear().rows.add(data.data).draw();
    }

    /**
     * 3) Initialize the Customer Management Module
     */
    function initCustomerManagement() {
        if (customerModule.customerTable) {
            customerModule.customerTable.destroy();
        }
        initCustomerTable();
        loadCustomers();
    }

    // Initialize DataTable and load data
    initCustomerManagement();

    // Refresh customers
    $("#refreshCustomerTable").click(function () {
        defaultLoadingSwalToast("Refrescando lista de clientes...");
        loadCustomers();
    });

    // Create new customer => go to second slide
    $("#createNewCustomer").click(function () {
        $("#customerModule").carousel(1);
    });

    /****************************************************
     * CREATE FORM SUBMISSION
     ****************************************************/
    $("#createCustomerForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("Creando cliente...");

        // Gather form values
        const firstName = $("#createCustomerFirstName").val();
        const lastName = $("#createCustomerLastName").val();
        const email = $("#createCustomerEmail").val();
        const address = $("#createCustomerAddress").val();
        const dateCreated = $("#createCustomerDate").val();

        google.script.run
            .withSuccessHandler((response) => {
                response = JSON.parse(response);
                if (response.status === 200) {
                    Swal.fire("Éxito!", "Cliente creado correctamente", "success");
                    // Refresh the table or add new row directly
                    loadCustomers();
                } else {
                    Swal.fire("Error", "No se pudo crear el cliente", "error");
                    console.warn("Create customer error:", response);
                }
            })
            .withFailureHandler((err) => {
                console.error("createCustomer error:", err);
                Swal.fire("Error", "No se pudo crear el cliente", "error");
            })
            .createCustomer({
                first_name: firstName,
                last_name: lastName,
                email: email,
                address: address,
                created_at: dateCreated,
            });
    });

    /****************************************************
     * EDIT FORM SUBMISSION
     ****************************************************/
    $("#editCustomerForm").on("submit", function (e) {
        e.preventDefault();

        // The ID from the hidden input or from currentRow
        const custId = $("#editCustomerId").val();

        // Gather form values
        const firstName = $("#editCustomerFirstName").val();
        const lastName = $("#editCustomerLastName").val();
        const email = $("#editCustomerEmail").val();
        const address = $("#editCustomerAddress").val();
        const dateCreated = $("#editCustomerDate").val();

        // Find the row being edited
        const $row = customerModule.customerTable.rows().nodes().toArray().find(row => {
            return customerModule.customerTable.row(row).data().id == custId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'cliente',
            fields: {
                '#editCustomerFirstName': 'first_name',
                '#editCustomerLastName': 'last_name',
                '#editCustomerEmail': 'email',
                '#editCustomerAddress': 'address',
                '#editCustomerDate': 'created_at'
            },
            id: custId,
            updatedData: {
                first_name: firstName,
                last_name: lastName,
                email: email,
                address: address,
                created_at: dateCreated
            },
            dataTable: customerModule.customerTable,
            $dataTableRow: $row,
            reloaderFunc: loadCustomers,
            scriptConfig: {
                mainFunction: 'updateCustomer',
                readRecordFunc: 'readCustomerById',
                requiresObject: true
            }
        });
    }); 
            


        /****************************************************
         * EDIT BUTTON CLICK in the table
         ****************************************************/
        $("#customerTable").on("click", ".editCustomer", function () {
            const custId = $(this).data("id");
            customerModule.currentRow = customerModule.customerTable
                .row($(this).closest("tr"))
                .data();

            console.log("Editing customer:", custId, customerModule.currentRow);

            // Fill the edit form
            $("#editCustomerId").val(customerModule.currentRow.id);
            $("#editCustomerFirstName").val(customerModule.currentRow.first_name);
            $("#editCustomerLastName").val(customerModule.currentRow.last_name);
            $("#editCustomerEmail").val(customerModule.currentRow.email);
            $("#editCustomerAddress").val(customerModule.currentRow.address);
            $("#editCustomerDate").val(
                customerModule.currentRow.created_at
                    ? customerModule.currentRow.created_at.substr(0, 10)
                    : ""
            );

            $("#customerModule").carousel(2); // navigate to edit form
        });

        /****************************************************
         * DELETE BUTTON CLICK in the table
         ****************************************************/
        $("#customerTable").on("click", ".deleteCustomer", function () {
            const custId = $(this).data("id");
            const $row = $(this).closest("tr");
            const rowData = customerModule.customerTable.row($row).data();

            console.log("Deleting customer:", custId, rowData);

            manageConcurrencyEditDelete({
                operation: 'removing',
                entity: 'cliente',
                id: custId,
                dataTable: customerModule.customerTable,
                $dataTableRow: $row,
                reloaderFunc: loadCustomers,
                scriptConfig: {
                    mainFunction: 'removeCustomer',
                    readRecordFunc: 'readCustomerById',
                    requiresObject: false
                }
            });
        });
      $("#customerTable").on("click", ".readCustomer", function () {
      const $row = $(this).closest("tr");
      console.log($row)
      const rowData = customerModule.customerTable.row($row).data();
      const customerId = rowData.id;
      console.log("Reading orders for Customer ID:", customerId);

      google.script.run
        .withSuccessHandler(displayCustomerOffcanvasResults)
        .getRelatedCustomerRecords(
          customerId
        );
    });

    window.lastCustomerResults = null;

    function displayCustomerOffcanvasResults(serverResponse) {
      const data = JSON.parse(serverResponse);
      window.lastCustomerResults = data;

      // Start with cards view
      buildCustomerCardsView(data);

      // Show the normal offcanvas
      const offcanvasEl = document.getElementById("offcanvasCustomer");
      const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
      bsOffcanvas.show();
    }

    // Toggle between JSON and cards for Customer
    $("#toggleViewBtnCustomer").on("click", function () {
      const currentView = $(this).attr("data-view");
      const data = window.lastCustomerResults || { data: [] };
      if (!data || !data.data) return;

      if (currentView === "cards") {
        // Switch to JSON
        buildCustomerJsonView(data);
        $(this).attr("data-view", "json").text("Ver Cards");
      } else {
        // Switch back to Cards
        buildCustomerCardsView(data);
        $(this).attr("data-view", "cards").text("Ver JSON");
      }
    });

    // Build Cards for Customer
    function buildCustomerCardsView(response) {
      const $body = $("#offcanvasCustomerBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron órdenes.</p>`);
        return;
      }

      response.data.forEach((order) => {
        /* Suppose each "order" has shape:
          { id: 10, customer_fk: 3, created_at: "2024-02-15", date: "2024-02-15" }
        */
        const cardHtml = `
          <div class="card mb-2">
            <div class="card-body d-flex">
              <i class="bi bi-cart-check me-3" style="font-size:2rem;"></i>
              <div>
                <h5 class="card-title mb-0">Orden #${order.id}</h5>
                <small class="text-muted">Fecha: ${order.date || "N/A"}</small>
                <p class="mt-2 mb-0">Creado: ${order.created_at || "N/A"}</p>
              </div>
            </div>
          </div>
        `;
        $body.append(cardHtml);
      });
    }

    // Build JSON for Customer
    function buildCustomerJsonView(response) {
      const $body = $("#offcanvasCustomerBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron órdenes.</p>`);
        return;
      }

      const pre = $("<pre></pre>").text(JSON.stringify(response.data, null, 2));
      $body.append(pre);
    }
    /****************************************************
     * OrderDetail Module Logic
     ****************************************************/
    const orderDetailModule = {
      orderDetailTable: null,
      currentRow: null,
    };

    function initOrderDetailTable() {
      orderDetailModule.orderDetailTable = $("#orderDetailTable").DataTable({
        responsive: true,
        language: {
          lengthMenu: "Mostrar _MENU_ detalles por página",
          zeroRecords: "No se encontraron registros",
        },
        columns: [
          {
            data: "id",
            render: function (data, type, row) {
              return `
                <div class="btn-group" role="group">
                  <button class="btn-custom btn-warning btn-rounded editOrderDetail" data-id="${data}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn-custom btn-danger btn-rounded deleteOrderDetail" data-id="${data}">
                    <i class="bi bi-trash"></i>
                  </button>
                  <button type="button" class="btn-custom btn-info btn-rounded readOrderDetail" data-id="${data}">
                    <i class="bi bi-info-circle-fill"></i>
                  </button>
                </div>
              `;
            },
          },
          { data: "order_id" },
          { data: "product_id" },
          { data: "quantity" },
          { data: "created_at" },
        ],
        columnDefs: [{ className: "text-center", targets: "_all" }],
      });
    }

    function loadOrderDetails() {
      google.script.run
        .withSuccessHandler(handleOrderDetailsLoaded)
        .withFailureHandler((error) => defaultSwalErr("cargar detalles", error))
        .readOrderDetailTable(); // your server function
    }

    function handleOrderDetailsLoaded(response) {
      const data = JSON.parse(response);
      console.log("loaded", data.data.length, "orderDetail records");
      orderDetailModule.orderDetailTable.clear().rows.add(data.data).draw();
    }

    function initOrderDetailManagement() {
      if (orderDetailModule.orderDetailTable) {
        orderDetailModule.orderDetailTable.destroy();
      }
      initOrderDetailTable();
      loadOrderDetails();
    }

    // 1) Initialize table & data
      initOrderDetailManagement();

      // 2) Initialize Select2 for create/edit forms
      $("#createOrderFk, #editOrderFk").select2({
        theme: "bootstrap-5",
        placeholder: "Seleccione una Orden",
        allowClear: true,
      });
      $("#createProductFk, #editProductFk").select2({
        theme: "bootstrap-5",
        placeholder: "Seleccione un Producto",
        allowClear: true,
      });

      // 3) Load Orders & Products for these dropdowns
      loadOrdersForSelect2();   // A function you define to fill #createOrderFk, #editOrderFk
      loadProductsForSelect2(); // A function you define to fill #createProductFk, #editProductFk

      // 4) Refresh table
      $("#refreshOrderDetailTable").on("click", function(){
        defaultLoadingSwalToast("Refrescando detalles...");
        loadOrderDetails();
      });

      // 5) Create new => carousel(1)
      $("#createNewOrderDetail").on("click", function() {
        $("#orderDetailModule").carousel(1);
      });

      /****************************************************
       * CREATE FORM SUBMISSION
       ****************************************************/
      $("#createOrderDetailForm").on("submit", function(e){
        e.preventDefault();
        defaultLoadingSwalToast("Creando detalle...");

        const orderId = $("#createOrderFk").val();
        const productId = $("#createProductFk").val();
        const quantity = $("#createOrderDetailQuantity").val();
        const createdAt = $("#createOrderDetailDate").val();

        google.script.run
          .withSuccessHandler((response)=>{
            response = JSON.parse(response);
            if(response.status === 200){
              Swal.fire("Éxito!", "Detalle creado correctamente", "success");
              loadOrderDetails(); // or directly add row
            } else {
              Swal.fire("Error", "No se pudo crear el detalle", "error");
              console.warn("Create orderDetail error:", response);
            }
          })
          .withFailureHandler((err)=>{
            console.error("createOrderDetail error:", err);
            Swal.fire("Error", "No se pudo crear el detalle", "error");
          })
          .createOrderDetail({
            order_id: Number(orderId),
            product_id: Number(productId),
            quantity: parseInt(quantity),
            created_at: createdAt,
          });
      });

      /****************************************************
       * EDIT FORM SUBMISSION
       ****************************************************/
      $("#editOrderDetailForm").on("submit", function(e){
        e.preventDefault();

        const detailId = $("#editOrderDetailId").val();
        const orderId = $("#editOrderFk").val();
        const productId = $("#editProductFk").val();
        const quantity = $("#editOrderDetailQuantity").val();
        const createdAt = $("#editOrderDetailDate").val();

        // Find the row being edited
        const $row = orderDetailModule.orderDetailTable.rows().nodes().toArray().find(row => {
            return orderDetailModule.orderDetailTable.row(row).data().id == detailId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'detalle',
            fields: {
                '#editOrderFk': 'order_id',
                '#editProductFk': 'product_id',
                '#editOrderDetailQuantity': 'quantity',
                '#editOrderDetailDate': 'created_at'
            },
            id: detailId,
            updatedData: {
                order_id: Number(orderId),
                product_id: Number(productId),
                quantity: parseInt(quantity),
                created_at: createdAt
            },
            dataTable: orderDetailModule.orderDetailTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrderDetails,
            scriptConfig: {
                mainFunction: 'updateOrderDetail',
                readRecordFunc: 'readOrderDetailById',
                requiresObject: true
            }
        });
      });

      /****************************************************
       * EDIT BUTTON CLICK
       ****************************************************/
      $("#orderDetailTable").on("click", ".editOrderDetail", function(){
        const detailId = $(this).data("id");
        orderDetailModule.currentRow = orderDetailModule.orderDetailTable
          .row($(this).closest("tr"))
          .data();

        console.log("Editing detail:", detailId, orderDetailModule.currentRow);

        // Fill the edit form
        $("#editOrderDetailId").val(orderDetailModule.currentRow.id);
        $("#editOrderFk")
          .val(orderDetailModule.currentRow.order_id)
          .trigger("change");
        $("#editProductFk")
          .val(orderDetailModule.currentRow.product_id)
          .trigger("change");
        $("#editOrderDetailQuantity").val(orderDetailModule.currentRow.quantity);
        $("#editOrderDetailDate").val(
          orderDetailModule.currentRow.created_at
            ? orderDetailModule.currentRow.created_at.substr(0, 10)
            : ""
        );

        $("#orderDetailModule").carousel(2);
      });

      /****************************************************
       * DELETE BUTTON CLICK
       ****************************************************/
      $("#orderDetailTable").on("click", ".deleteOrderDetail", function(){
        const detailId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = orderDetailModule.orderDetailTable.row($row).data();

        console.log("Deleting detail:", detailId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'detalle',
            id: detailId,
            dataTable: orderDetailModule.orderDetailTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrderDetails,
            scriptConfig: {
                mainFunction: 'removeOrderDetail',
                readRecordFunc: 'readOrderDetailById',
                requiresObject: false
            }
        });
      });

    /**
     * Functions to load Orders & Products into Select2
     * You already have readOrderTable() and readProductTable().
     */
    function loadOrdersForSelect2() {
      google.script.run
        .withSuccessHandler((res)=>{
          const data = JSON.parse(res);
          if(data.status===200){
            const $createOrder = $("#createOrderFk");
            const $editOrder = $("#editOrderFk");
            $createOrder.empty();
            $editOrder.empty();
            data.data.forEach(order=>{
              // e.g. show 'ID: customer_fk' or something
              $createOrder.append(
                new Option(`Orden #${order.id}`, order.id, false, false)
              );
              $editOrder.append(
                new Option(`Orden #${order.id}`, order.id, false, false)
              );
            });
            $createOrder.trigger("change");
            $editOrder.trigger("change");
          }
        })
        .readOrderTable();
    }

    function loadProductsForSelect2() {
      google.script.run
        .withSuccessHandler((res)=>{
          const data = JSON.parse(res);
          if(data.status===200){
            const $createProd = $("#createProductFk");
            const $editProd = $("#editProductFk");
            $createProd.empty();
            $editProd.empty();
            data.data.forEach(prod=>{
              $createProd.append(
                new Option(prod.name, prod.id, false, false)
              );
              $editProd.append(
                new Option(prod.name, prod.id, false, false)
              );
            });
            $createProd.trigger("change");
            $editProd.trigger("change");
          }
        })
        .readProductTable();
    }

     // The read button in the table
  $("#orderDetailTable").on("click", ".readOrderDetail", function () {
    const $row = $(this).closest("tr");
    const rowData = orderDetailModule.orderDetailTable.row($row).data();
    const orderId = rowData.order_id;
    const productId = rowData.product_id;
    console.log("Reading detail for ID:", orderId, productId);

    Swal.fire({
      title: "Búsqueda",
      text: "¿Desea buscar la relación desde la tabla 'Order' o 'Product'?",
      icon: "question",
      showDenyButton: true,
      confirmButtonText: "Order",
      denyButtonText: "Product",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler(displayOffcanvasResults)
          .readOrderDetailFromOrder(orderId);
      } else if (result.isDenied) {
        google.script.run
          .withSuccessHandler(displayOffcanvasResults)
          .readOrderDetailFromProduct(productId);
      }
    });
  });

  // The offcanvas results logic
  function displayOffcanvasResults(serverResponse) {
    const data = JSON.parse(serverResponse);
    // Save globally so we can rebuild UI when toggling
    window.lastJunctionResults = data;

    // Build initial "cards" view by default
    buildCardsView(data);

    // Show the offcanvas
    const offcanvasEl = document.getElementById("offcanvasSearch");
    const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
    bsOffcanvas.show();
  }

  // Toggle button
  $("#toggleViewBtn").on("click", function () {
    const currentView = $(this).attr("data-view");
    const data = window.lastJunctionResults || { data: [] };
    if (!data || !data.data) return;

    if (currentView === "cards") {
      // Switch to JSON
      buildJsonView(data);
      $(this).attr("data-view", "json").text("Ver Cards");
    } else {
      // Switch to cards
      buildCardsView(data);
      $(this).attr("data-view", "cards").text("Ver JSON");
    }
  });

  // Renders a user-friendly "cards" view
  function buildCardsView(response) {
    const $body = $("#offcanvasSearchBody");
    $body.empty();

    if (response.status !== 200) {
      $body.append(`<p>Error al obtener datos: ${response.error || "Desconocido"}</p>`);
      return;
    }
    if (response.data.length === 0) {
      $body.append(`<p>No se encontraron resultados.</p>`);
      return;
    }

    // Generate a Bootstrap card for each record
    response.data.forEach((item, idx) => {
      /*
        item might look like:
        {
          id: 1,
          order_id: 123,
          product_id: 45,
          quantity: 2,
          created_at: "2024-01-01T00:00:00.000Z",
          ...
        }
      */
      console.log(item);
      const cardHtml = `
        <div class="card mb-2">
          <div class="card-body d-flex align-items-center">
            <div class="me-3" style="font-size: 2rem;">
              <i class="bi bi-box-seam"></i>
            </div>
            <div>
              <h5 class="card-title mb-0">Detalle #${item.id}</h5>
              <small class="text-muted">Orden: ${item.relationship.order_id}, Producto: ${item.relationship.product_id}</small>
              <p class="mt-2 mb-0">Cantidad: ${item.relationship.quantity}</p>
              <p class="mb-0">Creado en: ${item.relationship.created_at || "N/A"}</p>
            </div>
          </div>
        </div>`;
      $body.append(cardHtml);
    });
  }

  // Renders a <pre> with raw JSON
  function buildJsonView(response) {
    const $body = $("#offcanvasSearchBody");
    $body.empty();

    if (response.status !== 200) {
      $body.append(`<p>Error al obtener datos: ${response.error || "Desconocido"}</p>`);
      return;
    }
    if (response.data.length === 0) {
      $body.append(`<p>No se encontraron resultados.</p>`);
      return;
    }

    const pre = $("<pre></pre>").text(JSON.stringify(response.data, null, 2));
    $body.append(pre);
  }

    function defaultLoadingSwalToast(reason) {
        let loadingToast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 10000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
                Swal.showLoading();
            }
        })
        loadingToast.fire({
            icon: "info",
            title: "Dejame Pensar🤓",
            html: `Dame un momento mientras ${reason}`,
        })
    }

    /****************************************************
     * Advanced Features Module Logic
     ****************************************************/
    const advancedFeaturesModule = {
        queryTimes: {
            normal: null,
            textFinder: null,
            filter: null
        }
    };

    // ========== Debugging & Logging Tests ==========

    $("#testUpdateWithLogs").on("click", function () {
        // Get first category and update it with logs
        google.script.run
            .withSuccessHandler((response) => {
                const data = JSON.parse(response);
                if (data.status === 200 && data.data.length > 0) {
                    const firstCat = data.data[0];
                    // Update it with logs
                    defaultLoadingSwalToast("actualizando con logs detallados...");
                    google.script.run
                        .withSuccessHandler((updateResponse) => {
                            const result = JSON.parse(updateResponse);
                            $("#debugOutput").text(JSON.stringify(result, null, 2));
                            Swal.fire({
                                icon: "success",
                                title: "Success!",
                                text: "Check the output for detailed logs",
                                timer: 2000
                            });
                        })
                        .withFailureHandler((err) => {
                            $("#debugOutput").text(`Error: ${err}`);
                            Swal.fire("Error", "Failed to update with logs", "error");
                        })
                        .updateCategoryWithLogs(
                            { name: firstCat.name, created_at: firstCat.created_at },
                            firstCat.id
                        );
                } else {
                    Swal.fire("Error", "No categories found to test with", "error");
                }
            })
            .withFailureHandler((err) => {
                Swal.fire("Error", `Failed to load categories: ${err}`, "error");
            })
            .readCategoryTable();
    });

    $("#testGetRelatedWithLogs").on("click", function () {
        const categoryId = prompt("Enter Category ID:");
        if (categoryId) {
            defaultLoadingSwalToast("obteniendo relaciones con logs...");
            google.script.run
                .withSuccessHandler((response) => {
                    const result = JSON.parse(response);
                    $("#debugOutput").text(JSON.stringify(result, null, 2));
                    Swal.fire({
                        icon: "success",
                        title: "Success!",
                        text: `Found ${result.data?.length || 0} related products`,
                        timer: 2000
                    });
                })
                .withFailureHandler((err) => {
                    $("#debugOutput").text(`Error: ${err}`);
                    Swal.fire("Error", "Failed to get related records with logs", "error");
                })
                .getCategoryRelatedRecordsWithLogs(Number(categoryId));
        }
    });

    $("#testGetCreationResult").on("click", function () {
        google.script.run
            .withSuccessHandler((response) => {
                const result = JSON.parse(response);
                $("#debugOutput").text(JSON.stringify(result, null, 2));
                Swal.fire({
                    icon: "info",
                    title: "Creation Result",
                    text: "Check the output for table creation details",
                    timer: 2000
                });
            })
            .withFailureHandler((err) => {
                $("#debugOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Failed to get creation result", "error");
            })
            .getLastCreationResult();
    });

    // ========== Data Integrity Tests ==========

    $("#testCheckIntegrity").on("click", function () {
        defaultLoadingSwalToast("verificando integridad de la tabla...");
        google.script.run
            .withSuccessHandler((response) => {
                const data = JSON.parse(response);
                $("#integrityOutput").text(JSON.stringify(data, null, 2));
                Swal.fire({
                    icon: data.status === 200 ? "success" : "error",
                    title: "Integrity Check Complete",
                    text: data.message || data.error
                });
            })
            .withFailureHandler((err) => {
                $("#integrityOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Failed to check integrity", "error");
            })
            .checkOrderDetailIntegrity();
    });

    $("#testDeleteJunctionRecords").on("click", function () {
        const orderId = prompt("Enter Order ID to delete junction records:");
        if (orderId) {
            defaultLoadingSwalToast("eliminando registros de junction...");
            google.script.run
                .withSuccessHandler((response) => {
                    const data = JSON.parse(response);
                    $("#integrityOutput").text(JSON.stringify(data, null, 2));
                    Swal.fire({
                        icon: data.status === 200 ? "success" : "error",
                        title: "Junction Records Deleted",
                        text: data.message || data.error
                    });
                })
                .withFailureHandler((err) => {
                    $("#integrityOutput").text(`Error: ${err}`);
                    Swal.fire("Error", "Failed to delete junction records", "error");
                })
                .deleteOrderDetailsByOrderId(Number(orderId));
        }
    });

    // ========== Query Alternatives Tests ==========

    $("#testTextFinder").on("click", function () {
        const fk = $("#queryForeignKey").val();
        if (!fk) {
            Swal.fire("Error", "Please enter a Category ID", "error");
            return;
        }

        const startTime = performance.now();
        defaultLoadingSwalToast("consultando con TextFinder...");
        google.script.run
            .withSuccessHandler((response) => {
                const endTime = performance.now();
                const timeTaken = (endTime - startTime).toFixed(2);
                advancedFeaturesModule.queryTimes.textFinder = timeTaken;

                const data = JSON.parse(response);
                const output = `Time: ${timeTaken}ms\nRecords: ${data.data?.length || 0}\n\n${JSON.stringify(data, null, 2)}`;
                $("#queryOutput").text(output);
                Swal.fire({
                    icon: "success",
                    title: "TextFinder Query Complete",
                    text: `Found ${data.data?.length || 0} records in ${timeTaken}ms`
                });
            })
            .withFailureHandler((err) => {
                $("#queryOutput").text(`Error: ${err}`);
                Swal.fire("Error", "TextFinder query failed", "error");
            })
            .getCategoryRelatedRecordsTextFinder(Number(fk));
    });

    $("#testFilterMethod").on("click", function () {
        const fk = $("#queryForeignKey").val();
        if (!fk) {
            Swal.fire("Error", "Please enter a Category ID", "error");
            return;
        }

        const startTime = performance.now();
        defaultLoadingSwalToast("consultando con Filter...");
        google.script.run
            .withSuccessHandler((response) => {
                const endTime = performance.now();
                const timeTaken = (endTime - startTime).toFixed(2);
                advancedFeaturesModule.queryTimes.filter = timeTaken;

                const data = JSON.parse(response);
                const output = `Time: ${timeTaken}ms\nRecords: ${data.data?.length || 0}\n\n${JSON.stringify(data, null, 2)}`;
                $("#queryOutput").text(output);
                Swal.fire({
                    icon: "success",
                    title: "Filter Query Complete",
                    text: `Found ${data.data?.length || 0} records in ${timeTaken}ms`
                });
            })
            .withFailureHandler((err) => {
                $("#queryOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Filter query failed", "error");
            })
            .getCategoryRelatedRecordsFilter(Number(fk));
    });

    $("#testNormalMethod").on("click", function () {
        const fk = $("#queryForeignKey").val();
        if (!fk) {
            Swal.fire("Error", "Please enter a Category ID", "error");
            return;
        }

        const startTime = performance.now();
        defaultLoadingSwalToast("consultando con método normal...");
        google.script.run
            .withSuccessHandler((response) => {
                const endTime = performance.now();
                const timeTaken = (endTime - startTime).toFixed(2);
                advancedFeaturesModule.queryTimes.normal = timeTaken;

                const data = JSON.parse(response);

                // Build comparison output
                let comparisonText = `=== NORMAL METHOD (Fastest) ===\nTime: ${timeTaken}ms\nRecords: ${data.data?.length || 0}\n\n`;

                if (advancedFeaturesModule.queryTimes.textFinder) {
                    const diff = (advancedFeaturesModule.queryTimes.textFinder - timeTaken).toFixed(2);
                    comparisonText += `TextFinder was ${diff}ms slower\n`;
                }
                if (advancedFeaturesModule.queryTimes.filter) {
                    const diff = (advancedFeaturesModule.queryTimes.filter - timeTaken).toFixed(2);
                    comparisonText += `Filter was ${diff}ms slower\n`;
                }

                comparisonText += `\n${JSON.stringify(data, null, 2)}`;
                $("#queryOutput").text(comparisonText);

                Swal.fire({
                    icon: "success",
                    title: "Normal Query Complete",
                    text: `Found ${data.data?.length || 0} records in ${timeTaken}ms`
                });
            })
            .withFailureHandler((err) => {
                $("#queryOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Normal query failed", "error");
            })
            .getCategoryRelatedRecords(Number(fk));
    });

    // ========== Visual Styling Test ==========

    $("#applyColorScheme").on("click", function () {
        const tableName = $("#styleTableName").val();
        const colorScheme = $("#styleColorScheme").val();

        defaultLoadingSwalToast("aplicando esquema de colores...");
        google.script.run
            .withSuccessHandler((response) => {
                const data = JSON.parse(response);
                $("#styleOutput").text(JSON.stringify(data, null, 2));
                Swal.fire({
                    icon: data.status === 200 ? "success" : "error",
                    title: data.status === 200 ? "Color Scheme Applied!" : "Error",
                    text: data.message || data.error || `Applied ${colorScheme} to ${tableName}`
                });
            })
            .withFailureHandler((err) => {
                $("#styleOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Failed to apply color scheme", "error");
            })
            .applyColorToTable(tableName, colorScheme);
    });

    });
</script>
<script>
  $(document).ready(function () {
    /****************************************************
     * Minimal UI utilities (no Bootstrap JS)
     * - Offcanvas: toggles `.show` on `.offcanvas`
     * - Carousel: toggles `.active` on `.carousel-item`
     ****************************************************/
    function openOffcanvas(selectorOrEl) {
      const el =
        typeof selectorOrEl === "string"
          ? document.querySelector(selectorOrEl)
          : selectorOrEl;
      if (!el) return;
      el.classList.add("show");
      el.setAttribute("aria-modal", "true");
      el.removeAttribute("aria-hidden");

      // backdrop
      if (!document.querySelector(".offcanvas-backdrop")) {
        const backdrop = document.createElement("div");
        backdrop.className = "offcanvas-backdrop";
        backdrop.addEventListener("click", () => closeOffcanvas(el));
        document.body.appendChild(backdrop);
        requestAnimationFrame(() => backdrop.classList.add("show"));
      }
    }

    function closeOffcanvas(selectorOrEl) {
      const el =
        typeof selectorOrEl === "string"
          ? document.querySelector(selectorOrEl)
          : selectorOrEl;
      if (!el) return;
      el.classList.remove("show");
      el.setAttribute("aria-hidden", "true");
      el.removeAttribute("aria-modal");

      const backdrop = document.querySelector(".offcanvas-backdrop");
      if (backdrop) {
        backdrop.classList.remove("show");
        setTimeout(() => backdrop.remove(), 200);
      }
    }

    function getCarouselEl(target) {
      if (!target) return null;
      if (typeof target === "string") return document.querySelector(target);
      return target;
    }

    function carouselSetSlide(carouselTarget, slideIndex) {
      const carouselEl = getCarouselEl(carouselTarget);
      if (!carouselEl) return;
      const items = Array.from(carouselEl.querySelectorAll(".carousel-item"));
      if (!items.length) return;
      const idx = Math.max(0, Math.min(items.length - 1, slideIndex));
      items.forEach((it, i) => it.classList.toggle("active", i === idx));
    }

    function carouselMove(carouselTarget, direction) {
      const carouselEl = getCarouselEl(carouselTarget);
      if (!carouselEl) return;
      const items = Array.from(carouselEl.querySelectorAll(".carousel-item"));
      if (!items.length) return;
      const currentIdx = Math.max(
        0,
        items.findIndex((it) => it.classList.contains("active"))
      );
      const nextIdx =
        direction === "next"
          ? Math.min(items.length - 1, currentIdx + 1)
          : Math.max(0, currentIdx - 1);
      carouselSetSlide(carouselEl, nextIdx);
    }

    // Bridge existing markup attributes (data-bs-*) to our plain JS
    document.addEventListener("click", (e) => {
      const openBtn = e.target.closest('[data-bs-toggle="offcanvas"]');
      if (openBtn) {
        const targetSel = openBtn.getAttribute("data-bs-target");
        if (targetSel) openOffcanvas(targetSel);
        return;
      }

      const dismissBtn = e.target.closest('[data-bs-dismiss="offcanvas"]');
      if (dismissBtn) {
        const offcanvasEl = dismissBtn.closest(".offcanvas");
        closeOffcanvas(offcanvasEl);
        return;
      }

      const slideBtn = e.target.closest("[data-bs-target][data-bs-slide]");
      if (slideBtn) {
        const targetSel = slideBtn.getAttribute("data-bs-target");
        const dir = slideBtn.getAttribute("data-bs-slide");
        carouselMove(targetSel, dir);
        return;
      }
    });

    const $modules = $(".module");

    // Tom Select instances storage
    const tomSelectInstances = {};

    function afterModuleShown($module) {
      // DataTables will mis-measure widths when initialized in hidden containers.
      // When we show a module, force a reflow for any tables inside it.
      try {
        const $tables = $module.find("table.display");
        $tables.each(function () {
          const api = $(this).DataTable?.();
          if (api && api.columns) {
            api.columns.adjust();
            // responsive recalculation (if enabled)
            api.responsive?.recalc?.();
          }
        });
      } catch (e) {
        // no-op
      }
    }

    // Inline loading state helper for Info buttons
    function setIconButtonLoading(btnEl, isLoading) {
      const $btn = $(btnEl);
      if (isLoading) {
        // Store original HTML
        $btn.data("original-html", $btn.html());
        $btn.prop("disabled", true);
        $btn.html('<i class="bi bi-arrow-repeat animate-spin"></i>');
        $btn.css("opacity", "0.6");
      } else {
        // Restore original HTML
        const originalHtml = $btn.data("original-html");
        if (originalHtml) {
          $btn.html(originalHtml);
          $btn.removeData("original-html");
        }
        $btn.prop("disabled", false);
        $btn.css("opacity", "1");
      }
    }

    // Loading state helper for regular buttons (with text and icons)
    function setButtonLoading(buttonId, isLoading) {
      const $btn = $(`#${buttonId}`);
      if (!$btn.length) return;
      
      if (isLoading) {
        // Store original HTML and disabled state
        if (!$btn.data("original-html")) {
          $btn.data("original-html", $btn.html());
        }
        $btn.data("original-disabled", $btn.prop("disabled"));
        
        // Extract text content (remove HTML tags)
        const originalHtml = $btn.data("original-html");
        const tempDiv = $('<div>').html(originalHtml);
        const textContent = tempDiv.text().trim();
        const firstWord = textContent.split(' ')[0] || 'Loading';
        
        // Replace content with spinner icon and first word
        $btn.prop("disabled", true);
        $btn.html(`<i class="bi bi-arrow-repeat animate-spin"></i> ${firstWord}...`);
        $btn.css("opacity", "0.7");
        $btn.css("cursor", "not-allowed");
      } else {
        // Restore original HTML
        const originalHtml = $btn.data("original-html");
        const originalDisabled = $btn.data("original-disabled");
        
        if (originalHtml) {
          $btn.html(originalHtml);
          $btn.removeData("original-html");
        }
        $btn.prop("disabled", originalDisabled !== undefined ? originalDisabled : false);
        $btn.removeData("original-disabled");
        $btn.css("opacity", "1");
        $btn.css("cursor", "");
      }
    }

    $(".offcanvas-body").on("click", "li.nav-item", function () {
      $(".nav-item").removeClass("active");
      $(this).addClass("active");

      $modules.hide();

      const moduleId = $(this).attr("data-module");
      const $target = $(`#${moduleId}`);
      $target.show();
      afterModuleShown($target);

      // On mobile, close the sidebar after selecting a section
      const sidebarEl = document.querySelector("#offcanvasSidebar");
      if (sidebarEl && window.matchMedia("(max-width: 1023px)").matches) {
        closeOffcanvas(sidebarEl);
      }
    });

    const categoryModule = {
        categoryTable: null,
        currentRow: null,
    }

    function initCategoryTable() {
        categoryModule.categoryTable = $("#categoryTable").DataTable({
            responsive: true,
            language: {
                "lengthMenu": "Mostrar _MENU_ categorias por página",
                "zeroRecords": "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
                      <div class="btn-group" role="group">
                        <button class="btn-custom btn-warning btn-rounded editCategory" data-id="${data}">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-custom btn-danger btn-rounded deleteCategory" data-id="${data}">
                          <i class="bi bi-trash"></i>
                        </button>
                        <button type="button" class="btn-custom btn-info btn-rounded readCategory" data-id="${data}">
                          <i class="bi bi-info-circle-fill"></i>
                        </button>
                      </div>`;
                    }
                },
                {data: "date"},
                {data: "name"},
                {data: "created_at"}
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"}
            ]
        })
    }

    function loadCategories() {
        google.script.run
            .withSuccessHandler(handleCategoriesLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar categorias", error))
            .readCategoryTable();
    }

    function handleCategoriesLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "categories");
        categoryModule.categoryTable.clear().rows.add(data.data).draw();
    }

    function initCategoryManagement() {
        if (categoryModule.categoryTable) {
            categoryModule.categoryTable.destroy();
        }
        initCategoryTable();
        loadCategories();
    }

    initCategoryManagement();

    $("#refreshCategoryTable").click(function () {
        defaultLoadingSwalToast("traigo nueva info!")
        loadCategories();
    })

    $("#createNewCategory").click(function () {
        carouselSetSlide("#categoryModule", 1);
    })

    $("#createCategoryForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("creo la categoria!")
        const newCatName = $("#createCategoryName").val().length > 0 ? $("#createCategoryName").val() : null;
        const newCatDate = $("#createCategoryDate").val();
        payload = {name: newCatName, created_at: newCatDate}
        // if (!newCatName){
        //   delete payload.name;
        // }
        google.script.run
            .withSuccessHandler((response) => {
                Swal.fire("Exito!", "Categoria Creada", "success");
                response = JSON.parse(response);
                console.log("created new category!", response);
                // const newCategory = response.
            })
            .createCategory(payload);

        console.log("Submitting new category:", newCatName, newCatDate);
    });

    $("#editCategoryForm").on("submit", function (e) {
        e.preventDefault();

        const catId = categoryModule.currentRow.id;
        const catName = $("#editCategoryName").val();
        const catDate = $("#editCategoryDate").val();

        // Find the row being edited
        const $row = categoryModule.categoryTable.rows().nodes().toArray().find(row => {
            return categoryModule.categoryTable.row(row).data().id === catId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'categoria',
            fields: {
                '#editCategoryName': 'name',
                '#editCategoryDate': 'created_at'
            },
            id: catId,
            updatedData: { name: catName, created_at: catDate },
            dataTable: categoryModule.categoryTable,
            $dataTableRow: $row,
            reloaderFunc: loadCategories,
            scriptConfig: {
                mainFunction: 'updateCategory',
                readRecordFunc: 'readCategoryById',
                requiresObject: true
            }
        });

        console.log("Updating category:", catId, catName, catDate);
    });

    // Listen for clicks on the editCategory button in each table row
    $("#categoryTable").on("click", ".editCategory", function () {
        // Get the category ID from the data-id attribute
        const catId = $(this).data("id");

        currentRow = categoryModule.categoryTable.row($(this).closest("tr")).data();

        console.log("Editing category:", catId, currentRow);

        // Fill the "Edit Category" form fields
        $("#editCategoryName").val(currentRow.name);
        // Decide which date field you want to use (rowData.date or rowData.created_at)
        $("#editCategoryDate").val(currentRow.created_at.substr(0, 10));

        carouselSetSlide("#categoryModule", 2);
    });

    $("#categoryTable").on("click", ".deleteCategory", function () {
        const catId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = categoryModule.categoryTable.row($row).data();
        console.log("Deleting category:", catId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'categoria',
            id: catId,
            dataTable: categoryModule.categoryTable,
            $dataTableRow: $row,
            reloaderFunc: loadCategories,
            scriptConfig: {
                mainFunction: 'removeCategory',
                readRecordFunc: 'readCategoryById',
                requiresObject: false
            }
        });
    })
    $("#categoryTable").on("click", ".readCategory", function () {
      const $btn = $(this);
      const $row = $btn.closest("tr");
      const rowData = categoryModule.categoryTable.row($row).data();
      const categoryId = rowData.id;
      console.log("Reading products for Category ID:", categoryId);

      setIconButtonLoading($btn[0], true);

      google.script.run
        .withSuccessHandler(function(response) {
          setIconButtonLoading($btn[0], false);
          displayCategoryOffcanvasResults(response);
        })
        .withFailureHandler(function(error) {
          setIconButtonLoading($btn[0], false);
          defaultSwalErr("cargar productos relacionados", error);
        })
        .getCategoryRelatedRecords(
          categoryId,
        );
    });

    window.lastCategoryResults = null;

    function displayCategoryOffcanvasResults(serverResponse) {
      const data = JSON.parse(serverResponse);
      window.lastCategoryResults = data;

      // Start with cards view
      buildCategoryCardsView(data);

      openOffcanvas("#offcanvasCategory");
    }

    // Toggle between JSON and cards for Category
    $("#toggleViewBtnCategory").on("click", function () {
      const currentView = $(this).attr("data-view");
      const data = window.lastCategoryResults || { data: [] };
      if (!data || !data.data) return;

      if (currentView === "cards") {
        // Switch to JSON
        buildCategoryJsonView(data);
        $(this).attr("data-view", "json").text("Ver Cards");
      } else {
        // Switch back to Cards
        buildCategoryCardsView(data);
        $(this).attr("data-view", "cards").text("Ver JSON");
      }
    });

    // Build Cards for Category
    function buildCategoryCardsView(response) {
      const $body = $("#offcanvasCategoryBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron productos.</p>`);
        return;
      }

      response.data.forEach((item) => {
        /* Suppose each "item" is a Product row:
          { id: 123, name: "Laptop", price: 999, category_fk: 4, created_at: "2024-01-01" }
        */
        const cardHtml = `
          <div class="card mb-2">
            <div class="card-body d-flex">
              <i class="bi bi-laptop me-3" style="font-size:2rem;"></i>
              <div>
                <h5 class="card-title mb-0">${item.name}</h5>
                <small class="text-muted">ID: ${item.id}</small>
                <p class="mt-2 mb-0">Precio: $${item.price}</p>
                <p class="mb-0">Fecha: ${item.created_at || "N/A"}</p>
              </div>
            </div>
          </div>`;
        $body.append(cardHtml);
      });
    }

    // Build JSON for Category
    function buildCategoryJsonView(response) {
      const $body = $("#offcanvasCategoryBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron productos.</p>`);
        return;
      }

      const pre = $("<pre></pre>").text(JSON.stringify(response.data, null, 2));
      $body.append(pre);
    }


    /****************************************************
     * Order Module Logic
     ****************************************************/
    const orderModule = {
        orderTable: null,
        currentRow: null, // store the currently selected row data (for editing)
    };


    function initOrderTable() {
        orderModule.orderTable = $("#orderTable").DataTable({
            responsive: true,
            language: {
                lengthMenu: "Mostrar _MENU_ órdenes por página",
                zeroRecords: "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
              <div class="btn-group" role="group">
                <button class="btn-custom btn-warning btn-rounded editOrder" data-id="${data}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn-custom btn-danger btn-rounded deleteOrder" data-id="${data}">
                  <i class="bi bi-trash"></i>
                </button>
                <button type="button" class="btn-custom btn-info btn-rounded readOrder" data-id="${data}">
                  <i class="bi bi-info-circle-fill"></i>
                </button>
              </div>`;
                    },
                },
                {data: "customer_fk"},
                {data: "created_at"},
                {data: "date"},
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"},
            ],
        });
    }

    function loadOrders() {
        google.script.run
            .withSuccessHandler(handleOrdersLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar órdenes", error))
            .readOrderTable();
    }

    function handleOrdersLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "orders");
        orderModule.orderTable.clear().rows.add(data.data).draw();
    }


    function loadCustomersForSelect() {
        google.script.run
            .withSuccessHandler(function (response) {
                const data = JSON.parse(response);
                if (data.status === 200) {
                    const customers = data.data.map(c => ({
                        value: c.id,
                        text: c.first_name + " " + c.last_name
                    }));
                    
                    // Initialize/create Tom Select for create order customer
                    const createSelect = document.getElementById("createOrderCustomer");
                    if (createSelect) {
                        if (tomSelectInstances.createOrderCustomer) {
                            tomSelectInstances.createOrderCustomer.clearOptions();
                            tomSelectInstances.createOrderCustomer.addOptions(customers);
                        } else {
                            tomSelectInstances.createOrderCustomer = new TomSelect(createSelect, {
                                options: customers,
                                placeholder: "Seleccione un cliente",
                                allowEmptyOption: true,
                                create: false
                            });
                        }
                    }
                    
                    // Initialize/create Tom Select for edit order customer
                    const editSelect = document.getElementById("editOrderCustomer");
                    if (editSelect) {
                        if (tomSelectInstances.editOrderCustomer) {
                            tomSelectInstances.editOrderCustomer.clearOptions();
                            tomSelectInstances.editOrderCustomer.addOptions(customers);
                        } else {
                            tomSelectInstances.editOrderCustomer = new TomSelect(editSelect, {
                                options: customers,
                                placeholder: "Seleccione un cliente",
                                allowEmptyOption: true,
                                create: false
                            });
                        }
                    }
                } else {
                    console.error("Error loading customers:", data);
                }
            })
            .withFailureHandler(function (err) {
                console.error("Apps Script error loading customers:", err);
            })
            .readCustomerTable();
    }

    /**
     * Re-initializes the Order table if needed, then loads data.
     */
    function initOrderManagement() {
        if (orderModule.orderTable) {
            orderModule.orderTable.destroy();
        }
        initOrderTable();
        loadOrders();

        // Initialize Tom Select for order customer selects
        const createOrderCustomerSelect = document.getElementById("createOrderCustomer");
        if (createOrderCustomerSelect && !tomSelectInstances.createOrderCustomer) {
            tomSelectInstances.createOrderCustomer = new TomSelect(createOrderCustomerSelect, {
                placeholder: "Seleccione un cliente",
                allowEmptyOption: true,
                create: false
            });
        }
        const editOrderCustomerSelect = document.getElementById("editOrderCustomer");
        if (editOrderCustomerSelect && !tomSelectInstances.editOrderCustomer) {
            tomSelectInstances.editOrderCustomer = new TomSelect(editOrderCustomerSelect, {
                placeholder: "Seleccione un cliente",
                allowEmptyOption: true,
                create: false
            });
        }
        loadCustomersForSelect();
    }

    // Call this once when the page is ready
    initOrderManagement();

    /****************************************************
     * Refresh Table
     ****************************************************/
    $("#refreshOrderTable").click(function () {
        defaultLoadingSwalToast("Cargando la información de órdenes...");
        loadOrders();
    });

    /****************************************************
     * CREATE NEW ORDER
     ****************************************************/
    $("#createNewOrder").click(function () {
        // Move carousel to the “Create Order” form
        carouselSetSlide("#orderModule", 1);
    });

    $("#createOrderForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("Creando nueva orden...");

        // Gather form values
        const newOrderCustomer = tomSelectInstances.createOrderCustomer ? tomSelectInstances.createOrderCustomer.getValue() : $("#createOrderCustomer").val();
        const newOrderDate = $("#createOrderDate").val();

        // Make server call
        google.script.run
            .withSuccessHandler((response) => {
                response = JSON.parse(response);
                if (response.status === 200) {
                    Swal.fire("Éxito!", "Orden creada correctamente", "success");
                    console.log("Created new order!", response);

                    // Optionally reload or append row to table
                    loadOrders();
                } else {
                    Swal.fire("Error", "No se pudo crear la orden", "error");
                }
            })
            .createOrder({
                customer_fk: Number(newOrderCustomer),
                created_at: newOrderDate,
            });

        console.log("Submitting new order:", newOrderCustomer, newOrderDate);
    });

    /****************************************************
     * EDIT ORDER
     ****************************************************/
    $("#editOrderForm").on("submit", function (e) {
        e.preventDefault();

        const orderId = orderModule.currentRow.id;
        const orderCustomer = tomSelectInstances.editOrderCustomer ? tomSelectInstances.editOrderCustomer.getValue() : $("#editOrderCustomer").val();
        const orderDate = $("#editOrderDate").val();

        // Find the row being edited
        const $row = orderModule.orderTable.rows().nodes().toArray().find(row => {
            return orderModule.orderTable.row(row).data().id === orderId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'orden',
            fields: {
                '#editOrderCustomer': 'customer_fk',
                '#editOrderDate': 'created_at'
            },
            id: orderId,
            updatedData: { customer_fk: Number(orderCustomer), created_at: orderDate },
            dataTable: orderModule.orderTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrders,
            scriptConfig: {
                mainFunction: 'updateOrder',
                readRecordFunc: 'readOrderById',
                requiresObject: true
            }
        });

        console.log("Updating order:", orderId, orderCustomer, orderDate);
    });

    /****************************************************
     * EDIT BUTTON CLICK
     ****************************************************/
    $("#orderTable").on("click", ".editOrder", function () {
        // Get the Order ID from the data-id attribute
        const orderId = $(this).data("id");
        // Store current row data in orderModule.currentRow
        orderModule.currentRow = orderModule.orderTable
            .row($(this).closest("tr"))
            .data();

        console.log("Editing order:", orderId, orderModule.currentRow);

        // Fill the Edit form
        if (tomSelectInstances.editOrderCustomer) {
          tomSelectInstances.editOrderCustomer.setValue(orderModule.currentRow.customer_fk);
        } else {
          $("#editOrderCustomer").val(orderModule.currentRow.customer_fk);
        }
        // date? depends on how you store it. Example:
        $("#editOrderDate").val(
            orderModule.currentRow.created_at
                ? orderModule.currentRow.created_at.substr(0, 10)
                : ""
        );

        // Move carousel to the “Edit Order” form (3rd slide => index=2)
        carouselSetSlide("#orderModule", 2);
    });

    /****************************************************
     * DELETE BUTTON CLICK
     ****************************************************/
    $("#orderTable").on("click", ".deleteOrder", function () {
        const orderId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = orderModule.orderTable.row($row).data();
        console.log("Deleting order:", orderId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'orden',
            id: orderId,
            dataTable: orderModule.orderTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrders,
            scriptConfig: {
                mainFunction: 'removeOrder',
                readRecordFunc: 'readOrderById',
                requiresObject: false
            }
        });
    });

    /****************************************************
     * Product Module Logic
     ****************************************************/
    const productModule = {
        productTable: null,
        currentRow: null, // store data of the currently selected row
    };

    // 1) Initialize DataTable
    function initProductTable() {
        productModule.productTable = $("#productTable").DataTable({
            responsive: true,
            language: {
                lengthMenu: "Mostrar _MENU_ productos por página",
                zeroRecords: "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
                  <div class="btn-group" role="group">
                    <button class="btn-custom btn-warning btn-rounded editProduct" data-id="${data}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn-custom btn-danger btn-rounded deleteProduct" data-id="${data}">
                      <i class="bi bi-trash"></i>
                    </button>
                    <button type="button" class="btn-custom btn-info btn-rounded readProduct" data-id="${data}">
                      <i class="bi bi-info-circle-fill"></i>
                    </button>
                  </div>
                `;
                    },
                },
                {data: "name"},
                {data: "price"},
                {data: "category_fk"},
                {data: "created_at"},
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"},
            ],
        });
    }

    // 2) Load Products from Server
    function loadProducts() {
        google.script.run
            .withSuccessHandler(handleProductsLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar productos", error))
            .readProductTable(); // your server function
    }

    function handleProductsLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "products");
        productModule.productTable.clear().rows.add(data.data).draw();
    }

    // 3) Initialize the Module
    function initProductManagement() {
        if (productModule.productTable) {
            productModule.productTable.destroy();
        }
        initProductTable();
        loadProducts();
    }

    initProductManagement();

    // Convert #createProductCategoryFk & #editProductCategoryFk into Tom Select
    const createProductCatSelect = document.getElementById("createProductCategoryFk");
    if (createProductCatSelect) {
        tomSelectInstances.createProductCategoryFk = new TomSelect(createProductCatSelect, {
            placeholder: "Seleccione una categoría",
            allowEmptyOption: true,
            create: false
        });
    }
    const editProductCatSelect = document.getElementById("editProductCategoryFk");
    if (editProductCatSelect) {
        tomSelectInstances.editProductCategoryFk = new TomSelect(editProductCatSelect, {
            placeholder: "Seleccione una categoría",
            allowEmptyOption: true,
            create: false
        });
    }

    // Load categories for the Tom Select dropdown
    loadCategoriesForTomSelect();

    // Refresh products
    $("#refreshProductTable").on("click", function () {
        defaultLoadingSwalToast("Refrescando lista de productos...");
        loadProducts();
    });

    // Create new product => go to carousel second slide
    $("#createNewProduct").on("click", function () {
        carouselSetSlide("#productModule", 1);
    });

    // Handle CREATE form submission
    $("#createProductForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("Creando producto...");

        // Gather form values
        const newName = $("#createProductName").val();
        const newPrice = $("#createProductPrice").val();
        const newCatId = tomSelectInstances.createProductCategoryFk ? tomSelectInstances.createProductCategoryFk.getValue() : $("#createProductCategoryFk").val();
        const newDate = $("#createProductDate").val();

        google.script.run
            .withSuccessHandler((response) => {
                response = JSON.parse(response);
                if (response.status === 200) {
                    Swal.fire("Éxito!", "Producto creado correctamente", "success");
                    loadProducts();
                } else {
                    Swal.fire("Error", "No se pudo crear el producto", "error");
                    console.warn("Create product error:", response);
                }
            })
            .withFailureHandler((err) => {
                console.error("createProduct error:", err);
                Swal.fire("Error", "No se pudo crear el producto", "error");
            })
            .createProduct({
                name: newName,
                price: parseFloat(newPrice),
                category_fk: Number(newCatId),
                created_at: newDate,
            });
    });

    // Handle EDIT form submission
    $("#editProductForm").on("submit", function (e) {
        e.preventDefault();

        // The ID from the hidden input or from productModule.currentRow
        const prodId = $("#editProductId").val();

        // Gather form values
        const prodName = $("#editProductName").val();
        const prodPrice = $("#editProductPrice").val();
        const prodCatId = tomSelectInstances.editProductCategoryFk ? tomSelectInstances.editProductCategoryFk.getValue() : $("#editProductCategoryFk").val();
        const prodDate = $("#editProductDate").val();

        // Find the row being edited
        const $row = productModule.productTable.rows().nodes().toArray().find(row => {
            return productModule.productTable.row(row).data().id == prodId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'producto',
            fields: {
                '#editProductName': 'name',
                '#editProductPrice': 'price',
                '#editProductCategoryFk': 'category_fk',
                '#editProductDate': 'created_at'
            },
            id: prodId,
            updatedData: {
                name: prodName,
                price: parseFloat(prodPrice),
                category_fk: Number(prodCatId),
                created_at: prodDate
            },
            dataTable: productModule.productTable,
            $dataTableRow: $row,
            reloaderFunc: loadProducts,
            scriptConfig: {
                mainFunction: 'updateProduct',
                readRecordFunc: 'readProductById',
                requiresObject: true
            }
        });
    });

    /****************************************************
     * EDIT BUTTON CLICK in the table
     ****************************************************/
    $("#productTable").on("click", ".editProduct", function () {
        const prodId = $(this).data("id");
        productModule.currentRow = productModule.productTable
            .row($(this).closest("tr"))
            .data();

        console.log("Editing product:", prodId, productModule.currentRow);

        // Fill the edit form
        $("#editProductId").val(productModule.currentRow.id);
        $("#editProductName").val(productModule.currentRow.name);
        $("#editProductPrice").val(productModule.currentRow.price);
        if (tomSelectInstances.editProductCategoryFk) {
            tomSelectInstances.editProductCategoryFk.setValue(productModule.currentRow.category_fk);
        }
        $("#editProductDate").val(
            productModule.currentRow.created_at
                ? productModule.currentRow.created_at.substr(0, 10)
                : ""
        );

        carouselSetSlide("#productModule", 2); // navigate to edit form
    });

    /****************************************************
     * DELETE BUTTON CLICK in the table
     ****************************************************/
    $("#productTable").on("click", ".deleteProduct", function () {
        const prodId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = productModule.productTable.row($row).data();

        console.log("Deleting product:", prodId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'producto',
            id: prodId,
            dataTable: productModule.productTable,
            $dataTableRow: $row,
            reloaderFunc: loadProducts,
            scriptConfig: {
                mainFunction: 'removeProduct',
                readRecordFunc: 'readProductById',
                requiresObject: false
            }
        });
    });

    /****************************************************
     * Load Categories for the Tom Select drop-down
     ****************************************************/
    function loadCategoriesForTomSelect() {
        google.script.run
            .withSuccessHandler((response) => {
                const data = JSON.parse(response);
                if (data.status === 200) {
                    const categories = data.data.map(cat => ({
                        value: cat.id,
                        text: cat.name
                    }));
                    
                    // Update Tom Select instances
                    if (tomSelectInstances.createProductCategoryFk) {
                        tomSelectInstances.createProductCategoryFk.clearOptions();
                        tomSelectInstances.createProductCategoryFk.addOptions(categories);
                    }
                    if (tomSelectInstances.editProductCategoryFk) {
                        tomSelectInstances.editProductCategoryFk.clearOptions();
                        tomSelectInstances.editProductCategoryFk.addOptions(categories);
                    }
                } else {
                    console.error("Failed to load categories:", data);
                }
            })
            .withFailureHandler((err) => {
                console.error("Error loading categories:", err);
            })
            .readCategoryTable();
    }


    /****************************************************
     * Customer Module Logic
     ****************************************************/
    const customerModule = {
        customerTable: null,
        currentRow: null, // store data of the currently selected row
    };

    /**
     * 1) Initialize DataTable
     */
    function initCustomerTable() {
        customerModule.customerTable = $("#customerTable").DataTable({
            responsive: true,
            language: {
                lengthMenu: "Mostrar _MENU_ clientes por página",
                zeroRecords: "No se encontraron registros",
            },
            columns: [
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
                  <div class="btn-group" role="group">
                    <button class="btn-custom btn-warning btn-rounded editCustomer" data-id="${data}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn-custom btn-danger btn-rounded deleteCustomer" data-id="${data}">
                      <i class="bi bi-trash"></i>
                    </button>
                    <button type="button" class="btn-custom btn-info btn-rounded readCustomer" data-id="${data}">
                      <i class="bi bi-info-circle-fill"></i>
                    </button>
                  </div>
                `;
                    },
                },
                {data: "first_name"},
                {data: "last_name"},
                {data: "email"},
                {data: "address"},
                {data: "created_at"},
            ],
            columnDefs: [
                {className: "text-center", targets: "_all"},
            ],
        });
    }

    /**
     * 2) Load Customers from Server
     */
    function loadCustomers() {
        google.script.run
            .withSuccessHandler(handleCustomersLoaded)
            .withFailureHandler((error) => defaultSwalErr("cargar clientes", error))
            .readCustomerTable(); // your server function
    }

    function handleCustomersLoaded(response) {
        const data = JSON.parse(response);
        console.log("loaded", data.data.length, "customers");
        customerModule.customerTable.clear().rows.add(data.data).draw();
    }

    /**
     * 3) Initialize the Customer Management Module
     */
    function initCustomerManagement() {
        if (customerModule.customerTable) {
            customerModule.customerTable.destroy();
        }
        initCustomerTable();
        loadCustomers();
    }

    // Initialize DataTable and load data
    initCustomerManagement();

    // Refresh customers
    $("#refreshCustomerTable").click(function () {
        defaultLoadingSwalToast("Refrescando lista de clientes...");
        loadCustomers();
    });

    // Create new customer => go to second slide
    $("#createNewCustomer").click(function () {
        carouselSetSlide("#customerModule", 1);
    });

    /****************************************************
     * CREATE FORM SUBMISSION
     ****************************************************/
    $("#createCustomerForm").on("submit", function (e) {
        e.preventDefault();
        defaultLoadingSwalToast("Creando cliente...");

        // Gather form values
        const firstName = $("#createCustomerFirstName").val();
        const lastName = $("#createCustomerLastName").val();
        const email = $("#createCustomerEmail").val();
        const address = $("#createCustomerAddress").val();
        const dateCreated = $("#createCustomerDate").val();

        google.script.run
            .withSuccessHandler((response) => {
                response = JSON.parse(response);
                if (response.status === 200) {
                    Swal.fire("Éxito!", "Cliente creado correctamente", "success");
                    // Refresh the table or add new row directly
                    loadCustomers();
                } else {
                    Swal.fire("Error", "No se pudo crear el cliente", "error");
                    console.warn("Create customer error:", response);
                }
            })
            .withFailureHandler((err) => {
                console.error("createCustomer error:", err);
                Swal.fire("Error", "No se pudo crear el cliente", "error");
            })
            .createCustomer({
                first_name: firstName,
                last_name: lastName,
                email: email,
                address: address,
                created_at: dateCreated,
            });
    });

    /****************************************************
     * EDIT FORM SUBMISSION
     ****************************************************/
    $("#editCustomerForm").on("submit", function (e) {
        e.preventDefault();

        // The ID from the hidden input or from currentRow
        const custId = $("#editCustomerId").val();

        // Gather form values
        const firstName = $("#editCustomerFirstName").val();
        const lastName = $("#editCustomerLastName").val();
        const email = $("#editCustomerEmail").val();
        const address = $("#editCustomerAddress").val();
        const dateCreated = $("#editCustomerDate").val();

        // Find the row being edited
        const $row = customerModule.customerTable.rows().nodes().toArray().find(row => {
            return customerModule.customerTable.row(row).data().id == custId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'cliente',
            fields: {
                '#editCustomerFirstName': 'first_name',
                '#editCustomerLastName': 'last_name',
                '#editCustomerEmail': 'email',
                '#editCustomerAddress': 'address',
                '#editCustomerDate': 'created_at'
            },
            id: custId,
            updatedData: {
                first_name: firstName,
                last_name: lastName,
                email: email,
                address: address,
                created_at: dateCreated
            },
            dataTable: customerModule.customerTable,
            $dataTableRow: $row,
            reloaderFunc: loadCustomers,
            scriptConfig: {
                mainFunction: 'updateCustomer',
                readRecordFunc: 'readCustomerById',
                requiresObject: true
            }
        });
    }); 
            


        /****************************************************
         * EDIT BUTTON CLICK in the table
         ****************************************************/
        $("#customerTable").on("click", ".editCustomer", function () {
            const custId = $(this).data("id");
            customerModule.currentRow = customerModule.customerTable
                .row($(this).closest("tr"))
                .data();

            console.log("Editing customer:", custId, customerModule.currentRow);

            // Fill the edit form
            $("#editCustomerId").val(customerModule.currentRow.id);
            $("#editCustomerFirstName").val(customerModule.currentRow.first_name);
            $("#editCustomerLastName").val(customerModule.currentRow.last_name);
            $("#editCustomerEmail").val(customerModule.currentRow.email);
            $("#editCustomerAddress").val(customerModule.currentRow.address);
            $("#editCustomerDate").val(
                customerModule.currentRow.created_at
                    ? customerModule.currentRow.created_at.substr(0, 10)
                    : ""
            );

            // navigate to edit form (plain JS carousel)
            carouselSetSlide("#customerModule", 2);
        });

        /****************************************************
         * DELETE BUTTON CLICK in the table
         ****************************************************/
        $("#customerTable").on("click", ".deleteCustomer", function () {
            const custId = $(this).data("id");
            const $row = $(this).closest("tr");
            const rowData = customerModule.customerTable.row($row).data();

            console.log("Deleting customer:", custId, rowData);

            manageConcurrencyEditDelete({
                operation: 'removing',
                entity: 'cliente',
                id: custId,
                dataTable: customerModule.customerTable,
                $dataTableRow: $row,
                reloaderFunc: loadCustomers,
                scriptConfig: {
                    mainFunction: 'removeCustomer',
                    readRecordFunc: 'readCustomerById',
                    requiresObject: false
                }
            });
        });
      $("#customerTable").on("click", ".readCustomer", function () {
      const $btn = $(this);
      const $row = $btn.closest("tr");
      console.log($row)
      const rowData = customerModule.customerTable.row($row).data();
      const customerId = rowData.id;
      console.log("Reading orders for Customer ID:", customerId);

      setIconButtonLoading($btn[0], true);

      google.script.run
        .withSuccessHandler(function(response) {
          setIconButtonLoading($btn[0], false);
          displayCustomerOffcanvasResults(response);
        })
        .withFailureHandler(function(error) {
          setIconButtonLoading($btn[0], false);
          defaultSwalErr("cargar órdenes relacionadas", error);
        })
        .getRelatedCustomerRecords(
          customerId
        );
    });

    window.lastCustomerResults = null;

    function displayCustomerOffcanvasResults(serverResponse) {
      const data = JSON.parse(serverResponse);
      window.lastCustomerResults = data;

      // Start with cards view
      buildCustomerCardsView(data);

      openOffcanvas("#offcanvasCustomer");
    }

    // Toggle between JSON and cards for Customer
    $("#toggleViewBtnCustomer").on("click", function () {
      const currentView = $(this).attr("data-view");
      const data = window.lastCustomerResults || { data: [] };
      if (!data || !data.data) return;

      if (currentView === "cards") {
        // Switch to JSON
        buildCustomerJsonView(data);
        $(this).attr("data-view", "json").text("Ver Cards");
      } else {
        // Switch back to Cards
        buildCustomerCardsView(data);
        $(this).attr("data-view", "cards").text("Ver JSON");
      }
    });

    // Build Cards for Customer
    function buildCustomerCardsView(response) {
      const $body = $("#offcanvasCustomerBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron órdenes.</p>`);
        return;
      }

      response.data.forEach((order) => {
        /* Suppose each "order" has shape:
          { id: 10, customer_fk: 3, created_at: "2024-02-15", date: "2024-02-15" }
        */
        const cardHtml = `
          <div class="card mb-2">
            <div class="card-body d-flex">
              <i class="bi bi-cart-check me-3" style="font-size:2rem;"></i>
              <div>
                <h5 class="card-title mb-0">Orden #${order.id}</h5>
                <small class="text-muted">Fecha: ${order.date || "N/A"}</small>
                <p class="mt-2 mb-0">Creado: ${order.created_at || "N/A"}</p>
              </div>
            </div>
          </div>
        `;
        $body.append(cardHtml);
      });
    }

    // Build JSON for Customer
    function buildCustomerJsonView(response) {
      const $body = $("#offcanvasCustomerBody");
      $body.empty();

      if (response.status !== 200) {
        $body.append(`<p>Error: ${response.error || "Desconocido"}</p>`);
        return;
      }
      if (!response.data || response.data.length === 0) {
        $body.append(`<p>No se encontraron órdenes.</p>`);
        return;
      }

      const pre = $("<pre></pre>").text(JSON.stringify(response.data, null, 2));
      $body.append(pre);
    }
    /****************************************************
     * OrderDetail Module Logic
     ****************************************************/
    const orderDetailModule = {
      orderDetailTable: null,
      currentRow: null,
    };

    function initOrderDetailTable() {
      orderDetailModule.orderDetailTable = $("#orderDetailTable").DataTable({
        responsive: true,
        language: {
          lengthMenu: "Mostrar _MENU_ detalles por página",
          zeroRecords: "No se encontraron registros",
        },
        columns: [
          {
            data: "id",
            render: function (data, type, row) {
              return `
                <div class="btn-group" role="group">
                  <button class="btn-custom btn-warning btn-rounded editOrderDetail" data-id="${data}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn-custom btn-danger btn-rounded deleteOrderDetail" data-id="${data}">
                    <i class="bi bi-trash"></i>
                  </button>
                  <button type="button" class="btn-custom btn-info btn-rounded readOrderDetail" data-id="${data}">
                    <i class="bi bi-info-circle-fill"></i>
                  </button>
                </div>
              `;
            },
          },
          { data: "order_id" },
          { data: "product_id" },
          { data: "quantity" },
          { data: "created_at" },
        ],
        columnDefs: [{ className: "text-center", targets: "_all" }],
      });
    }

    function loadOrderDetails() {
      google.script.run
        .withSuccessHandler(handleOrderDetailsLoaded)
        .withFailureHandler((error) => defaultSwalErr("cargar detalles", error))
        .readOrderDetailTable(); // your server function
    }

    function handleOrderDetailsLoaded(response) {
      const data = JSON.parse(response);
      console.log("loaded", data.data.length, "orderDetail records");
      orderDetailModule.orderDetailTable.clear().rows.add(data.data).draw();
    }

    function initOrderDetailManagement() {
      if (orderDetailModule.orderDetailTable) {
        orderDetailModule.orderDetailTable.destroy();
      }
      initOrderDetailTable();
      loadOrderDetails();
    }

    // 1) Initialize table & data
      initOrderDetailManagement();

      // 2) Initialize Tom Select for create/edit forms
      const createOrderFkSelect = document.getElementById("createOrderFk");
      if (createOrderFkSelect) {
        tomSelectInstances.createOrderFk = new TomSelect(createOrderFkSelect, {
          placeholder: "Seleccione una Orden",
          allowEmptyOption: true,
          create: false
        });
      }
      const editOrderFkSelect = document.getElementById("editOrderFk");
      if (editOrderFkSelect) {
        tomSelectInstances.editOrderFk = new TomSelect(editOrderFkSelect, {
          placeholder: "Seleccione una Orden",
          allowEmptyOption: true,
          create: false
        });
      }
      const createProductFkSelect = document.getElementById("createProductFk");
      if (createProductFkSelect) {
        tomSelectInstances.createProductFk = new TomSelect(createProductFkSelect, {
          placeholder: "Seleccione un Producto",
          allowEmptyOption: true,
          create: false
        });
      }
      const editProductFkSelect = document.getElementById("editProductFk");
      if (editProductFkSelect) {
        tomSelectInstances.editProductFk = new TomSelect(editProductFkSelect, {
          placeholder: "Seleccione un Producto",
          allowEmptyOption: true,
          create: false
        });
      }

      // 3) Load Orders & Products for these dropdowns
      loadOrdersForTomSelect();
      loadProductsForTomSelect();

      // 4) Refresh table
      $("#refreshOrderDetailTable").on("click", function(){
        defaultLoadingSwalToast("Refrescando detalles...");
        loadOrderDetails();
      });

      // 5) Create new => carousel(1)
      $("#createNewOrderDetail").on("click", function() {
        carouselSetSlide("#orderDetailModule", 1);
      });

      /****************************************************
       * CREATE FORM SUBMISSION
       ****************************************************/
      $("#createOrderDetailForm").on("submit", function(e){
        e.preventDefault();
        defaultLoadingSwalToast("Creando detalle...");

        const orderId = tomSelectInstances.createOrderFk ? tomSelectInstances.createOrderFk.getValue() : $("#createOrderFk").val();
        const productId = tomSelectInstances.createProductFk ? tomSelectInstances.createProductFk.getValue() : $("#createProductFk").val();
        const quantity = $("#createOrderDetailQuantity").val();
        const createdAt = $("#createOrderDetailDate").val();

        google.script.run
          .withSuccessHandler((response)=>{
            response = JSON.parse(response);
            if(response.status === 200){
              Swal.fire("Éxito!", "Detalle creado correctamente", "success");
              loadOrderDetails(); // or directly add row
            } else {
              Swal.fire("Error", "No se pudo crear el detalle", "error");
              console.warn("Create orderDetail error:", response);
            }
          })
          .withFailureHandler((err)=>{
            console.error("createOrderDetail error:", err);
            Swal.fire("Error", "No se pudo crear el detalle", "error");
          })
          .createOrderDetail({
            order_id: Number(orderId),
            product_id: Number(productId),
            quantity: parseInt(quantity),
            created_at: createdAt,
          });
      });

      /****************************************************
       * EDIT FORM SUBMISSION
       ****************************************************/
      $("#editOrderDetailForm").on("submit", function(e){
        e.preventDefault();

        const detailId = $("#editOrderDetailId").val();
        const orderId = tomSelectInstances.editOrderFk ? tomSelectInstances.editOrderFk.getValue() : $("#editOrderFk").val();
        const productId = tomSelectInstances.editProductFk ? tomSelectInstances.editProductFk.getValue() : $("#editProductFk").val();
        const quantity = $("#editOrderDetailQuantity").val();
        const createdAt = $("#editOrderDetailDate").val();

        // Find the row being edited
        const $row = orderDetailModule.orderDetailTable.rows().nodes().toArray().find(row => {
            return orderDetailModule.orderDetailTable.row(row).data().id == detailId;
        });

        manageConcurrencyEditDelete({
            operation: 'edition',
            entity: 'detalle',
            fields: {
                '#editOrderFk': 'order_id',
                '#editProductFk': 'product_id',
                '#editOrderDetailQuantity': 'quantity',
                '#editOrderDetailDate': 'created_at'
            },
            id: detailId,
            updatedData: {
                order_id: Number(orderId),
                product_id: Number(productId),
                quantity: parseInt(quantity),
                created_at: createdAt
            },
            dataTable: orderDetailModule.orderDetailTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrderDetails,
            scriptConfig: {
                mainFunction: 'updateOrderDetail',
                readRecordFunc: 'readOrderDetailById',
                requiresObject: true
            }
        });
      });

      /****************************************************
       * EDIT BUTTON CLICK
       ****************************************************/
      $("#orderDetailTable").on("click", ".editOrderDetail", function(){
        const detailId = $(this).data("id");
        orderDetailModule.currentRow = orderDetailModule.orderDetailTable
          .row($(this).closest("tr"))
          .data();

        console.log("Editing detail:", detailId, orderDetailModule.currentRow);

        // Fill the edit form
        $("#editOrderDetailId").val(orderDetailModule.currentRow.id);
        if (tomSelectInstances.editOrderFk) {
          tomSelectInstances.editOrderFk.setValue(orderDetailModule.currentRow.order_id);
        }
        if (tomSelectInstances.editProductFk) {
          tomSelectInstances.editProductFk.setValue(orderDetailModule.currentRow.product_id);
        }
        $("#editOrderDetailQuantity").val(orderDetailModule.currentRow.quantity);
        $("#editOrderDetailDate").val(
          orderDetailModule.currentRow.created_at
            ? orderDetailModule.currentRow.created_at.substr(0, 10)
            : ""
        );

        carouselSetSlide("#orderDetailModule", 2);
      });

      /****************************************************
       * DELETE BUTTON CLICK
       ****************************************************/
      $("#orderDetailTable").on("click", ".deleteOrderDetail", function(){
        const detailId = $(this).data("id");
        const $row = $(this).closest("tr");
        const rowData = orderDetailModule.orderDetailTable.row($row).data();

        console.log("Deleting detail:", detailId, rowData);

        manageConcurrencyEditDelete({
            operation: 'removing',
            entity: 'detalle',
            id: detailId,
            dataTable: orderDetailModule.orderDetailTable,
            $dataTableRow: $row,
            reloaderFunc: loadOrderDetails,
            scriptConfig: {
                mainFunction: 'removeOrderDetail',
                readRecordFunc: 'readOrderDetailById',
                requiresObject: false
            }
        });
      });

    /**
     * Functions to load Orders & Products into Tom Select
     */
    function loadOrdersForTomSelect() {
      google.script.run
        .withSuccessHandler((res)=>{
          const data = JSON.parse(res);
          if(data.status===200){
            const orders = data.data.map(order => ({
              value: order.id,
              text: `Orden #${order.id}`
            }));
            if (tomSelectInstances.createOrderFk) {
              tomSelectInstances.createOrderFk.clearOptions();
              tomSelectInstances.createOrderFk.addOptions(orders);
            }
            if (tomSelectInstances.editOrderFk) {
              tomSelectInstances.editOrderFk.clearOptions();
              tomSelectInstances.editOrderFk.addOptions(orders);
            }
          }
        })
        .readOrderTable();
    }

    function loadProductsForTomSelect() {
      google.script.run
        .withSuccessHandler((res)=>{
          const data = JSON.parse(res);
          if(data.status===200){
            const products = data.data.map(prod => ({
              value: prod.id,
              text: prod.name
            }));
            if (tomSelectInstances.createProductFk) {
              tomSelectInstances.createProductFk.clearOptions();
              tomSelectInstances.createProductFk.addOptions(products);
            }
            if (tomSelectInstances.editProductFk) {
              tomSelectInstances.editProductFk.clearOptions();
              tomSelectInstances.editProductFk.addOptions(products);
            }
          }
        })
        .readProductTable();
    }

     // The read button in the table
  $("#orderDetailTable").on("click", ".readOrderDetail", function () {
    const $btn = $(this);
    const $row = $btn.closest("tr");
    const rowData = orderDetailModule.orderDetailTable.row($row).data();
    const orderId = rowData.order_id;
    const productId = rowData.product_id;
    console.log("Reading detail for ID:", orderId, productId);

    setIconButtonLoading($btn[0], true);

    Swal.fire({
      title: "Búsqueda",
      text: "¿Desea buscar la relación desde la tabla 'Order' o 'Product'?",
      icon: "question",
      showDenyButton: true,
      confirmButtonText: "Order",
      denyButtonText: "Product",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler(function(response) {
            setIconButtonLoading($btn[0], false);
            displayOffcanvasResults(response);
          })
          .withFailureHandler(function(error) {
            setIconButtonLoading($btn[0], false);
            defaultSwalErr("cargar detalles de orden", error);
          })
          .readOrderDetailFromOrder(orderId);
      } else if (result.isDenied) {
        google.script.run
          .withSuccessHandler(function(response) {
            setIconButtonLoading($btn[0], false);
            displayOffcanvasResults(response);
          })
          .withFailureHandler(function(error) {
            setIconButtonLoading($btn[0], false);
            defaultSwalErr("cargar detalles de producto", error);
          })
          .readOrderDetailFromProduct(productId);
      } else {
        // User dismissed the dialog
        setIconButtonLoading($btn[0], false);
      }
    });
  });

  // The offcanvas results logic
  function displayOffcanvasResults(serverResponse) {
    const data = JSON.parse(serverResponse);
    // Save globally so we can rebuild UI when toggling
    window.lastJunctionResults = data;

    // Build initial "cards" view by default
    buildCardsView(data);

    openOffcanvas("#offcanvasSearch");
  }

  // Toggle button
  $("#toggleViewBtn").on("click", function () {
    const currentView = $(this).attr("data-view");
    const data = window.lastJunctionResults || { data: [] };
    if (!data || !data.data) return;

    if (currentView === "cards") {
      // Switch to JSON
      buildJsonView(data);
      $(this).attr("data-view", "json").text("Ver Cards");
    } else {
      // Switch to cards
      buildCardsView(data);
      $(this).attr("data-view", "cards").text("Ver JSON");
    }
  });

  // Renders a user-friendly "cards" view
  function buildCardsView(response) {
    const $body = $("#offcanvasSearchBody");
    $body.empty();

    if (response.status !== 200) {
      $body.append(`<p>Error al obtener datos: ${response.error || "Desconocido"}</p>`);
      return;
    }
    if (response.data.length === 0) {
      $body.append(`<p>No se encontraron resultados.</p>`);
      return;
    }

    // Generate a Bootstrap card for each record
    response.data.forEach((item, idx) => {
      /*
        item might look like:
        {
          id: 1,
          order_id: 123,
          product_id: 45,
          quantity: 2,
          created_at: "2024-01-01T00:00:00.000Z",
          ...
        }
      */
      console.log(item);
      const cardHtml = `
        <div class="card mb-2">
          <div class="card-body d-flex align-items-center">
            <div class="me-3" style="font-size: 2rem;">
              <i class="bi bi-box-seam"></i>
            </div>
            <div>
              <h5 class="card-title mb-0">Detalle #${item.id}</h5>
              <small class="text-muted">Orden: ${item.relationship.order_id}, Producto: ${item.relationship.product_id}</small>
              <p class="mt-2 mb-0">Cantidad: ${item.relationship.quantity}</p>
              <p class="mb-0">Creado en: ${item.relationship.created_at || "N/A"}</p>
            </div>
          </div>
        </div>`;
      $body.append(cardHtml);
    });
  }

  // Renders a <pre> with raw JSON
  function buildJsonView(response) {
    const $body = $("#offcanvasSearchBody");
    $body.empty();

    if (response.status !== 200) {
      $body.append(`<p>Error al obtener datos: ${response.error || "Desconocido"}</p>`);
      return;
    }
    if (response.data.length === 0) {
      $body.append(`<p>No se encontraron resultados.</p>`);
      return;
    }

    const pre = $("<pre></pre>").text(JSON.stringify(response.data, null, 2));
    $body.append(pre);
  }

    function defaultLoadingSwalToast(reason) {
        let loadingToast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 10000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
                Swal.showLoading();
            }
        })
        loadingToast.fire({
            icon: "info",
            title: "Dejame Pensar🤓",
            html: `Dame un momento mientras ${reason}`,
        })
    }

    /****************************************************
     * Advanced Features Module Logic
     ****************************************************/
    const advancedFeaturesModule = {
        queryTimes: {
            normal: null,
            textFinder: null,
            filter: null
        }
    };

    // ========== Debugging & Logging Tests ==========

    $("#testUpdateWithLogs").on("click", function () {
        const $btn = $(this);
        setButtonLoading("testUpdateWithLogs", true);
        
        // Get first category and update it with logs
        google.script.run
            .withSuccessHandler((response) => {
                const data = JSON.parse(response);
                if (data.status === 200 && data.data.length > 0) {
                    const firstCat = data.data[0];
                    // Update it with logs
                    defaultLoadingSwalToast("actualizando con logs detallados...");
                    google.script.run
                        .withSuccessHandler((updateResponse) => {
                            setButtonLoading("testUpdateWithLogs", false);
                            const result = JSON.parse(updateResponse);
                            $("#debugOutput").text(JSON.stringify(result, null, 2));
                            Swal.fire({
                                icon: "success",
                                title: "Success!",
                                text: "Check the output for detailed logs",
                                timer: 2000
                            });
                        })
                        .withFailureHandler((err) => {
                            setButtonLoading("testUpdateWithLogs", false);
                            $("#debugOutput").text(`Error: ${err}`);
                            Swal.fire("Error", "Failed to update with logs", "error");
                        })
                        .updateCategoryWithLogs(
                            { name: firstCat.name, created_at: firstCat.created_at },
                            firstCat.id
                        );
                } else {
                    setButtonLoading("testUpdateWithLogs", false);
                    Swal.fire("Error", "No categories found to test with", "error");
                }
            })
            .withFailureHandler((err) => {
                setButtonLoading("testUpdateWithLogs", false);
                Swal.fire("Error", `Failed to load categories: ${err}`, "error");
            })
            .readCategoryTable();
    });

    $("#testGetRelatedWithLogs").on("click", function () {
        showInputModal({
            title: "Get Related Records with Logs",
            label: "Enter Category ID:",
            placeholder: "e.g., 1",
            inputType: "number",
            onConfirm: (categoryId) => {
                if (!categoryId) {
                    Swal.fire("Error", "Please enter a Category ID", "error");
                    return;
                }
                setButtonLoading("testGetRelatedWithLogs", true);
                defaultLoadingSwalToast("obteniendo relaciones con logs...");
                google.script.run
                    .withSuccessHandler((response) => {
                        setButtonLoading("testGetRelatedWithLogs", false);
                        const result = JSON.parse(response);
                        $("#debugOutput").text(JSON.stringify(result, null, 2));
                        Swal.fire({
                            icon: "success",
                            title: "Success!",
                            text: `Found ${result.data?.length || 0} related products`,
                            timer: 2000
                        });
                    })
                    .withFailureHandler((err) => {
                        setButtonLoading("testGetRelatedWithLogs", false);
                        $("#debugOutput").text(`Error: ${err}`);
                        Swal.fire("Error", "Failed to get related records with logs", "error");
                    })
                    .getCategoryRelatedRecordsWithLogs(Number(categoryId));
            }
        });
    });

    $("#testGetCreationResult").on("click", function () {
        setButtonLoading("testGetCreationResult", true);
        google.script.run
            .withSuccessHandler((response) => {
                setButtonLoading("testGetCreationResult", false);
                const result = JSON.parse(response);
                $("#debugOutput").text(JSON.stringify(result, null, 2));
                Swal.fire({
                    icon: "info",
                    title: "Creation Result",
                    text: "Check the output for table creation details",
                    timer: 2000
                });
            })
            .withFailureHandler((err) => {
                setButtonLoading("testGetCreationResult", false);
                $("#debugOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Failed to get creation result", "error");
            })
            .getLastCreationResult();
    });

    // ========== Data Integrity Tests ==========

    $("#testCheckIntegrity").on("click", function () {
        setButtonLoading("testCheckIntegrity", true);
        defaultLoadingSwalToast("verificando integridad de la tabla...");
        google.script.run
            .withSuccessHandler((response) => {
                setButtonLoading("testCheckIntegrity", false);
                const data = JSON.parse(response);
                $("#integrityOutput").text(JSON.stringify(data, null, 2));
                Swal.fire({
                    icon: data.status === 200 ? "success" : "error",
                    title: "Integrity Check Complete",
                    text: data.message || data.error
                });
            })
            .withFailureHandler((err) => {
                setButtonLoading("testCheckIntegrity", false);
                $("#integrityOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Failed to check integrity", "error");
            })
            .checkOrderDetailIntegrity();
    });

    $("#testDeleteJunctionRecords").on("click", function () {
        showInputModal({
            title: "Delete Junction Records",
            label: "Enter Order ID to delete junction records:",
            placeholder: "e.g., 1",
            inputType: "number",
            onConfirm: (orderId) => {
                if (!orderId) {
                    Swal.fire("Error", "Please enter an Order ID", "error");
                    return;
                }
                setButtonLoading("testDeleteJunctionRecords", true);
                defaultLoadingSwalToast("eliminando registros de junction...");
                google.script.run
                    .withSuccessHandler((response) => {
                        setButtonLoading("testDeleteJunctionRecords", false);
                        const data = JSON.parse(response);
                        $("#integrityOutput").text(JSON.stringify(data, null, 2));
                        Swal.fire({
                            icon: data.status === 200 ? "success" : "error",
                            title: "Junction Records Deleted",
                            text: data.message || data.error
                        });
                    })
                    .withFailureHandler((err) => {
                        setButtonLoading("testDeleteJunctionRecords", false);
                        $("#integrityOutput").text(`Error: ${err}`);
                        Swal.fire("Error", "Failed to delete junction records", "error");
                    })
                    .deleteOrderDetailsByOrderId(Number(orderId));
            }
        });
    });

    // ========== Query Alternatives Tests ==========

    $("#testTextFinder").on("click", function () {
        const fk = $("#queryForeignKey").val();
        if (!fk) {
            Swal.fire("Error", "Please enter a Category ID", "error");
            return;
        }

        setButtonLoading("testTextFinder", true);
        const startTime = performance.now();
        defaultLoadingSwalToast("consultando con TextFinder...");
        google.script.run
            .withSuccessHandler((response) => {
                setButtonLoading("testTextFinder", false);
                const endTime = performance.now();
                const timeTaken = (endTime - startTime).toFixed(2);
                advancedFeaturesModule.queryTimes.textFinder = timeTaken;

                const data = JSON.parse(response);
                const output = `Time: ${timeTaken}ms\nRecords: ${data.data?.length || 0}\n\n${JSON.stringify(data, null, 2)}`;
                $("#queryOutput").text(output);
                Swal.fire({
                    icon: "success",
                    title: "TextFinder Query Complete",
                    text: `Found ${data.data?.length || 0} records in ${timeTaken}ms`
                });
            })
            .withFailureHandler((err) => {
                setButtonLoading("testTextFinder", false);
                $("#queryOutput").text(`Error: ${err}`);
                Swal.fire("Error", "TextFinder query failed", "error");
            })
            .getCategoryRelatedRecordsTextFinder(Number(fk));
    });

    $("#testFilterMethod").on("click", function () {
        const fk = $("#queryForeignKey").val();
        if (!fk) {
            Swal.fire("Error", "Please enter a Category ID", "error");
            return;
        }

        setButtonLoading("testFilterMethod", true);
        const startTime = performance.now();
        defaultLoadingSwalToast("consultando con Filter...");
        google.script.run
            .withSuccessHandler((response) => {
                setButtonLoading("testFilterMethod", false);
                const endTime = performance.now();
                const timeTaken = (endTime - startTime).toFixed(2);
                advancedFeaturesModule.queryTimes.filter = timeTaken;

                const data = JSON.parse(response);
                const output = `Time: ${timeTaken}ms\nRecords: ${data.data?.length || 0}\n\n${JSON.stringify(data, null, 2)}`;
                $("#queryOutput").text(output);
                Swal.fire({
                    icon: "success",
                    title: "Filter Query Complete",
                    text: `Found ${data.data?.length || 0} records in ${timeTaken}ms`
                });
            })
            .withFailureHandler((err) => {
                setButtonLoading("testFilterMethod", false);
                $("#queryOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Filter query failed", "error");
            })
            .getCategoryRelatedRecordsFilter(Number(fk));
    });

    $("#testNormalMethod").on("click", function () {
        const fk = $("#queryForeignKey").val();
        if (!fk) {
            Swal.fire("Error", "Please enter a Category ID", "error");
            return;
        }

        setButtonLoading("testNormalMethod", true);
        const startTime = performance.now();
        defaultLoadingSwalToast("consultando con método normal...");
        google.script.run
            .withSuccessHandler((response) => {
                setButtonLoading("testNormalMethod", false);
                const endTime = performance.now();
                const timeTaken = (endTime - startTime).toFixed(2);
                advancedFeaturesModule.queryTimes.normal = timeTaken;

                const data = JSON.parse(response);

                // Build comparison output
                let comparisonText = `=== NORMAL METHOD (Fastest) ===\nTime: ${timeTaken}ms\nRecords: ${data.data?.length || 0}\n\n`;

                if (advancedFeaturesModule.queryTimes.textFinder) {
                    const diff = (advancedFeaturesModule.queryTimes.textFinder - timeTaken).toFixed(2);
                    comparisonText += `TextFinder was ${diff}ms slower\n`;
                }
                if (advancedFeaturesModule.queryTimes.filter) {
                    const diff = (advancedFeaturesModule.queryTimes.filter - timeTaken).toFixed(2);
                    comparisonText += `Filter was ${diff}ms slower\n`;
                }

                comparisonText += `\n${JSON.stringify(data, null, 2)}`;
                $("#queryOutput").text(comparisonText);

                Swal.fire({
                    icon: "success",
                    title: "Normal Query Complete",
                    text: `Found ${data.data?.length || 0} records in ${timeTaken}ms`
                });
            })
            .withFailureHandler((err) => {
                setButtonLoading("testNormalMethod", false);
                $("#queryOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Normal query failed", "error");
            })
            .getCategoryRelatedRecords(Number(fk));
    });

    // ========== Visual Styling Test ==========

    $("#applyColorScheme").on("click", function () {
        const tableName = $("#styleTableName").val();
        const colorScheme = $("#styleColorScheme").val();

        setButtonLoading("applyColorScheme", true);
        defaultLoadingSwalToast("aplicando esquema de colores...");
        google.script.run
            .withSuccessHandler((response) => {
                setButtonLoading("applyColorScheme", false);
                const data = JSON.parse(response);
                $("#styleOutput").text(JSON.stringify(data, null, 2));
                Swal.fire({
                    icon: data.status === 200 ? "success" : "error",
                    title: data.status === 200 ? "Color Scheme Applied!" : "Error",
                    text: data.message || data.error || `Applied ${colorScheme} to ${tableName}`
                });
            })
            .withFailureHandler((err) => {
                setButtonLoading("applyColorScheme", false);
                $("#styleOutput").text(`Error: ${err}`);
                Swal.fire("Error", "Failed to apply color scheme", "error");
            })
            .applyColorToTable(tableName, colorScheme);
    });

    /****************************************************
     * Dark Mode Toggle (System Default + Persistence)
     ****************************************************/
    function getSystemTheme() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === 'system') {
            theme = getSystemTheme();
        }
        if (theme === 'dark') {
            root.classList.add('dark');
        } else {
            root.classList.remove('dark');
        }
        updateThemeIcon(theme === 'dark' ? 'dark' : (theme === 'system' ? getSystemTheme() : 'light'));
    }

    function updateThemeIcon(theme) {
        const icon = document.getElementById('themeIcon');
        if (icon) {
            icon.className = theme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';
        }
    }

    function initTheme() {
        const saved = localStorage.getItem('theme') || 'system';
        applyTheme(saved);
        
        // Listen for system theme changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'system' || !savedTheme) {
                    applyTheme('system');
                }
            });
        }
    }

    $('#themeToggle').on('click', function() {
        const current = localStorage.getItem('theme') || 'system';
        let next;
        if (current === 'system') {
            next = getSystemTheme() === 'dark' ? 'light' : 'dark';
        } else if (current === 'dark') {
            next = 'light';
        } else {
            next = 'system';
        }
        localStorage.setItem('theme', next);
        applyTheme(next);
    });

    initTheme();

    /****************************************************
     * Input Modal (Tailwind-based, replaces browser prompt)
     ****************************************************/
    function showInputModal({ title, label, placeholder = "", inputType = "text", onConfirm, onCancel }) {
        const modalId = 'inputModal_' + Date.now();
        const $modal = $(`
            <div id="${modalId}" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
                <div class="w-full max-w-md mx-4 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">${title}</h3>
                    </div>
                    <div class="p-6">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">${label}</label>
                        <input 
                            type="${inputType}" 
                            id="${modalId}_input" 
                            placeholder="${placeholder}"
                            class="w-full px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4"
                            autofocus
                        />
                        <div class="flex gap-2 justify-end">
                            <button 
                                type="button" 
                                class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700"
                                data-action="cancel"
                            >
                                Cancel
                            </button>
                            <button 
                                type="button" 
                                class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"
                                data-action="confirm"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        $('body').append($modal);
        $modal.removeClass('hidden').addClass('flex');
        
        const $input = $modal.find(`#${modalId}_input`);
        $input.focus();
        
        $input.on('keydown', function(e) {
            if (e.key === 'Enter') {
                $modal.find('[data-action="confirm"]').trigger('click');
            } else if (e.key === 'Escape') {
                $modal.find('[data-action="cancel"]').trigger('click');
            }
        });
        
        $modal.find('[data-action="confirm"]').on('click', function() {
            const value = $input.val();
            $modal.remove();
            if (onConfirm) onConfirm(value);
        });
        
        $modal.find('[data-action="cancel"]').on('click', function() {
            $modal.remove();
            if (onCancel) onCancel();
        });
        
        $modal.on('click', function(e) {
            if ($(e.target).is($modal)) {
                $modal.remove();
                if (onCancel) onCancel();
            }
        });
    }

    /****************************************************
     * Search Bar + Command Palette
     ****************************************************/
    
    // Function registry: maps function names to modules and button IDs
    const functionRegistry = [
        // Category Module
        { func: 'readCategoryTable', module: 'categoryModule', buttonId: 'refreshCategoryTable', label: 'Read Categories', keywords: ['read', 'category', 'categories', 'get', 'load'] },
        { func: 'createCategory', module: 'categoryModule', buttonId: 'createNewCategory', label: 'Create Category', keywords: ['create', 'category', 'new', 'add'] },
        { func: 'updateCategory', module: 'categoryModule', buttonId: null, label: 'Update Category', keywords: ['update', 'edit', 'category', 'modify'] },
        { func: 'deleteCategory', module: 'categoryModule', buttonId: null, label: 'Delete Category', keywords: ['delete', 'remove', 'category'] },
        { func: 'getCategoryRelatedRecords', module: 'categoryModule', buttonId: null, label: 'Get Related Records', keywords: ['related', 'getrelated', 'relationship', 'join'] },
        
        // Order Module
        { func: 'readOrderTable', module: 'orderModule', buttonId: 'refreshOrderTable', label: 'Read Orders', keywords: ['read', 'order', 'orders', 'get', 'load'] },
        { func: 'createOrder', module: 'orderModule', buttonId: 'createNewOrder', label: 'Create Order', keywords: ['create', 'order', 'new', 'add'] },
        { func: 'updateOrder', module: 'orderModule', buttonId: null, label: 'Update Order', keywords: ['update', 'edit', 'order', 'modify'] },
        { func: 'deleteOrder', module: 'orderModule', buttonId: null, label: 'Delete Order', keywords: ['delete', 'remove', 'order'] },
        { func: 'getRelatedCustomerRecords', module: 'orderModule', buttonId: null, label: 'Get Related Customer', keywords: ['related', 'customer', 'getrelated'] },
        
        // Product Module
        { func: 'readProductTable', module: 'productModule', buttonId: 'refreshProductTable', label: 'Read Products', keywords: ['read', 'product', 'products', 'get', 'load'] },
        { func: 'createProduct', module: 'productModule', buttonId: 'createNewProduct', label: 'Create Product', keywords: ['create', 'product', 'new', 'add'] },
        { func: 'updateProduct', module: 'productModule', buttonId: null, label: 'Update Product', keywords: ['update', 'edit', 'product', 'modify'] },
        { func: 'deleteProduct', module: 'productModule', buttonId: null, label: 'Delete Product', keywords: ['delete', 'remove', 'product'] },
        
        // Customer Module
        { func: 'readCustomerTable', module: 'customerModule', buttonId: 'refreshCustomerTable', label: 'Read Customers', keywords: ['read', 'customer', 'customers', 'get', 'load'] },
        { func: 'createCustomer', module: 'customerModule', buttonId: 'createNewCustomer', label: 'Create Customer', keywords: ['create', 'customer', 'new', 'add'] },
        { func: 'updateCustomer', module: 'customerModule', buttonId: null, label: 'Update Customer', keywords: ['update', 'edit', 'customer', 'modify'] },
        { func: 'deleteCustomer', module: 'customerModule', buttonId: null, label: 'Delete Customer', keywords: ['delete', 'remove', 'customer'] },
        
        // Order Detail Module
        { func: 'readOrderDetailTable', module: 'orderDetailModule', buttonId: 'refreshOrderDetailTable', label: 'Read Order Details', keywords: ['read', 'orderdetail', 'order detail', 'junction', 'get', 'load'] },
        { func: 'createOrderDetail', module: 'orderDetailModule', buttonId: 'createNewOrderDetail', label: 'Create Order Detail', keywords: ['create', 'orderdetail', 'new', 'add'] },
        { func: 'updateOrderDetail', module: 'orderDetailModule', buttonId: null, label: 'Update Order Detail', keywords: ['update', 'edit', 'orderdetail', 'modify'] },
        { func: 'deleteOrderDetail', module: 'orderDetailModule', buttonId: null, label: 'Delete Order Detail', keywords: ['delete', 'remove', 'orderdetail'] },
        { func: 'readOrderDetailFromOrder', module: 'orderDetailModule', buttonId: null, label: 'Read from Order', keywords: ['read', 'orderdetail', 'from order', 'junction'] },
        { func: 'readOrderDetailFromProduct', module: 'orderDetailModule', buttonId: null, label: 'Read from Product', keywords: ['read', 'orderdetail', 'from product', 'junction'] },
        
        // Advanced Features
        { func: 'updateCategoryWithLogs', module: 'advancedFeaturesModule', buttonId: 'testUpdateWithLogs', label: 'Update with Logs', keywords: ['update', 'logs', 'logging', 'debug'] },
        { func: 'getCategoryRelatedRecordsWithLogs', module: 'advancedFeaturesModule', buttonId: 'testGetRelatedWithLogs', label: 'Get Related with Logs', keywords: ['getrelated', 'related', 'logs', 'logging', 'debug'] },
        { func: 'getLastCreationResult', module: 'advancedFeaturesModule', buttonId: 'testGetCreationResult', label: 'Get Creation Result', keywords: ['creation', 'result', 'create', 'last'] },
        { func: 'checkOrderDetailIntegrity', module: 'advancedFeaturesModule', buttonId: 'testCheckIntegrity', label: 'Check Integrity', keywords: ['integrity', 'check', 'validate', 'verify'] },
        { func: 'deleteOrderDetailsByOrderId', module: 'advancedFeaturesModule', buttonId: 'testDeleteJunctionRecords', label: 'Delete Junction Records', keywords: ['delete', 'junction', 'records', 'orderid'] },
        { func: 'getCategoryRelatedRecordsTextFinder', module: 'advancedFeaturesModule', buttonId: 'testTextFinder', label: 'Query with TextFinder', keywords: ['textfinder', 'query', 'search', 'filter'] },
        { func: 'getCategoryRelatedRecordsFilter', module: 'advancedFeaturesModule', buttonId: 'testFilterMethod', label: 'Query with Filter', keywords: ['filter', 'query', 'search'] },
        { func: 'getCategoryRelatedRecordsNormal', module: 'advancedFeaturesModule', buttonId: 'testNormalMethod', label: 'Query Normal', keywords: ['normal', 'query', 'fast', 'standard'] },
        { func: 'applyColorToTable', module: 'advancedFeaturesModule', buttonId: 'applyColorScheme', label: 'Apply Color Scheme', keywords: ['color', 'scheme', 'styling', 'apply'] }
    ];
    
    const moduleSuggestions = [
        { id: 'categoryModule', label: 'Categorias', keywords: ['category', 'categoria', 'categories', 'categorias'] },
        { id: 'orderModule', label: 'Ordenes', keywords: ['order', 'orden', 'orders', 'ordenes'] },
        { id: 'productModule', label: 'Productos', keywords: ['product', 'producto', 'products', 'productos'] },
        { id: 'customerModule', label: 'Clientes', keywords: ['customer', 'cliente', 'customers', 'clientes'] },
        { id: 'orderDetailModule', label: 'Detalle de Orden', keywords: ['orderdetail', 'order detail', 'detalle orden', 'orderdetail', 'junction'] },
        { id: 'advancedFeaturesModule', label: 'Advanced Features', keywords: ['advanced', 'features', 'getrelatedrecords', 'getrelated', 'checkintegrity', 'textfinder', 'filter', 'query'] }
    ];

    function filterSuggestions(query) {
        if (!query) return moduleSuggestions;
        const lowerQuery = query.toLowerCase();
        
        // Search modules
        const moduleMatches = moduleSuggestions.filter(s => 
            s.label.toLowerCase().includes(lowerQuery) ||
            s.keywords.some(k => k.toLowerCase().includes(lowerQuery))
        );
        
        // Search functions
        const functionMatches = functionRegistry.filter(f => 
            f.func.toLowerCase().includes(lowerQuery) ||
            f.label.toLowerCase().includes(lowerQuery) ||
            f.keywords.some(k => k.toLowerCase().includes(lowerQuery))
        );
        
        // Combine and limit results
        const results = [];
        
        // Add module matches (max 3)
        moduleMatches.slice(0, 3).forEach(m => {
            results.push({ type: 'module', ...m });
        });
        
        // Add function matches (max 7)
        functionMatches.slice(0, 7).forEach(f => {
            results.push({ type: 'function', ...f });
        });
        
        return results.slice(0, 10);
    }

    function navigateToModule(moduleId, buttonId = null) {
        const $navItem = $(`.nav-item[data-module="${moduleId}"]`);
        if ($navItem.length) {
            $navItem.trigger('click');
            
            // Highlight button if provided
            if (buttonId) {
                setTimeout(() => {
                    const $button = $(`#${buttonId}`);
                    if ($button.length) {
                        // Scroll to button
                        $button[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Highlight animation
                        $button.addClass('ring-4 ring-indigo-500 ring-opacity-75');
                        setTimeout(() => {
                            $button.removeClass('ring-4 ring-indigo-500 ring-opacity-75');
                        }, 2000);
                    }
                }, 300);
            }
        }
    }

    /**
     * Highlights all occurrences of query in text (case-insensitive)
     * @param {string} text - The text to highlight
     * @param {string} query - The search query
     * @returns {string} - HTML string with all matches highlighted
     */
    function highlightAllMatches(text, query) {
        if (!query || !text) return text;
        // Escape special regex characters and create case-insensitive regex
        const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedQuery})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    // Search bar typeahead
    const $searchInput = $('#globalSearch');
    let $suggestionsDropdown = null;
    let currentSearchQuery = '';

    function showSuggestions(suggestions, query = '') {
        if (!$searchInput.length) return;
        
        if (!$suggestionsDropdown) {
            $suggestionsDropdown = $('<div id="searchSuggestions" class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-lg z-50 max-h-64 overflow-y-auto"></div>');
            $searchInput.parent().css('position', 'relative').append($suggestionsDropdown);
        }
        
        if (suggestions.length === 0) {
            $suggestionsDropdown.hide();
            return;
        }

        const html = suggestions.map(s => {
            if (s.type === 'function') {
                const highlightedLabel = highlightAllMatches(s.label, query);
                const highlightedFunc = highlightAllMatches(s.func, query);
                const highlightedModule = highlightAllMatches(s.module.replace('Module', ''), query);
                return `
                    <button type="button" class="w-full text-left px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-slate-200" data-module="${s.module}" data-button-id="${s.buttonId || ''}">
                        <div class="font-medium">${highlightedLabel}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">
                            <code class="text-xs">${highlightedFunc}</code> • ${highlightedModule}
                        </div>
                    </button>
                `;
            } else {
                const highlightedLabel = highlightAllMatches(s.label, query);
                return `
                    <button type="button" class="w-full text-left px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-slate-200" data-module="${s.id}">
                        <div class="font-medium">${highlightedLabel}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Module</div>
                    </button>
                `;
            }
        }).join('');
        $suggestionsDropdown.html(html).show();

        $suggestionsDropdown.find('button').on('click', function() {
            const moduleId = $(this).data('module');
            const buttonId = $(this).data('button-id');
            navigateToModule(moduleId, buttonId);
            $searchInput.val('');
            $suggestionsDropdown.hide();
        });
    }

    if ($searchInput.length) {
        $searchInput.on('input', function() {
            const query = $(this).val();
            currentSearchQuery = query;
            const suggestions = filterSuggestions(query);
            showSuggestions(suggestions, query);
        });

        $searchInput.on('keydown', function(e) {
            if (e.key === 'Escape') {
                $suggestionsDropdown?.hide();
            } else if (e.key === 'Enter' && $suggestionsDropdown && $suggestionsDropdown.is(':visible')) {
                const $first = $suggestionsDropdown.find('button').first();
                if ($first.length) {
                    $first.trigger('click');
                }
            }
        });

        $(document).on('click', function(e) {
            if (!$searchInput.is(e.target) && !$suggestionsDropdown?.is(e.target) && !$suggestionsDropdown?.has(e.target).length) {
                $suggestionsDropdown?.hide();
            }
        });
    }

    // Command Palette (Cmd/Ctrl+K)
    const $commandPalette = $('<div id="commandPalette" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"><div class="w-full max-w-lg mx-4 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden"><div class="p-4 border-b border-slate-200 dark:border-slate-700"><input type="text" id="commandPaletteInput" placeholder="Type to search modules..." class="w-full px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"/></div><div id="commandPaletteResults" class="max-h-96 overflow-y-auto"></div></div></div>');
    $('body').append($commandPalette);

    function showCommandPalette() {
        $commandPalette.removeClass('hidden').addClass('flex');
        $('#commandPaletteInput').val('').focus();
        updateCommandPaletteResults('');
    }

    function hideCommandPalette() {
        $commandPalette.addClass('hidden').removeClass('flex');
    }

    function updateCommandPaletteResults(query) {
        const suggestions = filterSuggestions(query);
        const $results = $('#commandPaletteResults');
        if (suggestions.length === 0) {
            $results.html('<div class="p-4 text-center text-slate-500 dark:text-slate-400">No results found</div>');
            return;
        }
        const html = suggestions.map(s => {
            if (s.type === 'function') {
                const highlightedLabel = highlightAllMatches(s.label, query);
                const highlightedFunc = highlightAllMatches(s.func, query);
                const highlightedModule = highlightAllMatches(s.module.replace('Module', ''), query);
                return `
                    <button type="button" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 dark:bg-slate-800 dark:text-slate-200 border-b border-slate-100 dark:border-slate-700 last:border-0" data-module="${s.module}" data-button-id="${s.buttonId || ''}">
                        <div class="font-medium">${highlightedLabel}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">
                            <code class="text-xs">${highlightedFunc}</code> • ${highlightedModule} • Press Enter to navigate
                        </div>
                    </button>
                `;
            } else {
                const highlightedLabel = highlightAllMatches(s.label, query);
                return `
                    <button type="button" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 dark:bg-slate-800 dark:text-slate-200 border-b border-slate-100 dark:border-slate-700 last:border-0" data-module="${s.id}">
                        <div class="font-medium">${highlightedLabel}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Press Enter to navigate</div>
                    </button>
                `;
            }
        }).join('');
        $results.html(html);

        $results.find('button').on('click', function() {
            const moduleId = $(this).data('module');
            const buttonId = $(this).data('button-id');
            navigateToModule(moduleId, buttonId);
            hideCommandPalette();
        });
    }

    $('#commandPaletteInput').on('input', function() {
        updateCommandPaletteResults($(this).val());
    });

    $('#commandPaletteInput').on('keydown', function(e) {
        if (e.key === 'Escape') {
            hideCommandPalette();
        } else if (e.key === 'Enter') {
            const $first = $('#commandPaletteResults button').first();
            if ($first.length) {
                $first.trigger('click');
            }
        }
    });

    $commandPalette.on('click', function(e) {
        if ($(e.target).is($commandPalette)) {
            hideCommandPalette();
        }
    });

    $(document).on('keydown', function(e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            showCommandPalette();
        }
    });
});
</script>